{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
    .drag-drop-zone {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background-color: #f9f9f9;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        cursor: pointer;
    }
    
    .drag-drop-zone.drag-over {
        border-color: #417690;
        background-color: #e8f4f8;
        transform: scale(1.02);
    }
    
    .drag-drop-zone:hover {
        border-color: #999;
        background-color: #f0f0f0;
    }
    
    .drag-drop-icon {
        font-size: 48px;
        color: #999;
        margin-bottom: 10px;
    }
    
    .drag-drop-zone.drag-over .drag-drop-icon {
        color: #417690;
    }
    
    .drag-drop-text {
        font-size: 16px;
        color: #666;
        margin-bottom: 10px;
    }
    
    .drag-drop-hint {
        font-size: 13px;
        color: #999;
    }
    
    .file-info {
        margin-top: 15px;
        padding: 10px;
        background-color: #e8f4f8;
        border-radius: 4px;
        display: none;
    }
    
    .file-info.show {
        display: block;
    }
    
    .traditional-upload {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module">
        <h1>–ò–º–ø–æ—Ä—Ç GeoJSON –∫–∞—Ä—Ç</h1>
        
        <div class="help">
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É —Ñ–æ—Ä–º—É –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–π –∏–∑ GeoJSON —Ñ–∞–π–ª–æ–≤.</p>
            <ul>
                <li>–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ GeoJSON (.geojson –∏–ª–∏ .json)</li>
                <li>–ö–∞–∂–¥—ã–π –ø–æ–ª–∏–≥–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏—Ü–µ–Ω–∑–∏–∏ –≤ –ø–æ–ª–µ properties</li>
                <li>–ï—Å–ª–∏ –ª–∏—Ü–µ–Ω–∑–∏—è —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã</li>
                <li>–í—Å–µ –ø–æ–ª–∏–≥–æ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤—è—Ç—Å—è –Ω–∞ –µ–¥–∏–Ω—É—é –∫–∞—Ä—Ç—É</li>
            </ul>
        </div>
        
        <form method="post" enctype="multipart/form-data" class="aligned" id="uploadForm">
            {% csrf_token %}
            
            <div class="drag-drop-zone" id="dropZone">
                <div class="drag-drop-icon">üìÅ</div>
                <div class="drag-drop-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ GeoJSON —Ñ–∞–π–ª —Å—é–¥–∞</div>
                <div class="drag-drop-hint">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</div>
            </div>
            
            <div class="file-info" id="fileInfo">
                <strong>–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª:</strong> <span id="fileName"></span>
            </div>
            
            <div class="traditional-upload">
                <div class="form-row">
                    <div>
                        <label for="id_geojson_file">–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º:</label>
                        <input type="file" name="geojson_file" id="id_geojson_file" accept=".geojson,.json">
                        <p class="help">–í—ã–±–µ—Ä–∏—Ç–µ GeoJSON —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞</p>
                    </div>
                </div>
            </div>
            
            <div class="submit-row">
                <input type="submit" value="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å" class="default">
                <a href="{% url 'admin:licenses_license_changelist' %}" class="button cancel-link">–û—Ç–º–µ–Ω–∞</a>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('id_geojson_file');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const uploadForm = document.getElementById('uploadForm');
    const submitBtn = uploadForm.querySelector('input[type="submit"]');
    
    let selectedFile = null;
    
    dropZone.addEventListener('click', () => {
        fileInput.click();
    });
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('drag-over');
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('drag-over');
        }, false);
    });
    
    dropZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            const file = files[0];
            
            if (file.name.endsWith('.geojson') || file.name.endsWith('.json')) {
                selectedFile = file;
                showFileInfo(file.name);
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª .geojson –∏–ª–∏ .json');
            }
        }
    }
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            selectedFile = e.target.files[0];
            showFileInfo(selectedFile.name);
        }
    });
    
    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        if (!selectedFile && fileInput.files.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
            return;
        }
        
        const fileToUpload = selectedFile || fileInput.files[0];
        
        if (!fileToUpload.name.endsWith('.geojson') && !fileToUpload.name.endsWith('.json')) {
            alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ .geojson –∏ .json');
            return;
        }
        
        const formData = new FormData();
        formData.append('geojson_file', fileToUpload);
        formData.append('csrfmiddlewaretoken', uploadForm.querySelector('[name=csrfmiddlewaretoken]').value);
        
        submitBtn.value = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        submitBtn.disabled = true;
        
        fetch(uploadForm.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': uploadForm.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text().then(text => {
                    document.open();
                    document.write(text);
                    document.close();
                });
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            submitBtn.value = '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å';
            submitBtn.disabled = false;
        });
    });
    
    function showFileInfo(name) {
        fileName.textContent = name;
        fileInfo.classList.add('show');
    }
})();
</script>
{% endblock %}
