{% extends 'licenses/base.html' %}

{% block title %}Интерактивная карта лицензий{% endblock %}

{% block extra_css %}
<style>
    body {
        overflow-y: auto;
        background-color: #ffffff;
    }

    .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0;
    }

    /* Quick Navigation Menu */
    .quick-nav {
        position: sticky;
        top: 0;
        background: white;
        border-bottom: 1px solid var(--border-color);
        z-index: 999;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .quick-nav-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0.75rem 2rem;
        gap: 1rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .quick-nav-link {
        padding: 0.625rem 1.5rem;
        color: var(--text-muted);
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9375rem;
        transition: all 0.2s;
        display: inline-block;
    }

    .quick-nav-link:hover {
        background: var(--bg-section);
        color: var(--text-dark);
        transform: translateY(-1px);
    }

    .quick-nav-link.external {
        background: var(--accent-color);
        color: white;
    }

    .quick-nav-link.external:hover {
        background: var(--accent-hover);
        color: white;
    }

    /* Back to Top Button */
    .back-to-top {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: var(--accent-color);
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        transition: all 0.3s;
        z-index: 1000;
        border: none;
    }

    .back-to-top:hover {
        background: var(--accent-hover);
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(255, 107, 53, 0.4);
    }

    .back-to-top.show {
        display: flex;
    }

    .hero-section {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: white;
        padding: 4rem 2rem 3rem;
        position: relative;
    }

    .hero-title {
        font-size: 3.5rem;
        font-weight: 700;
        letter-spacing: -0.04em;
        margin-bottom: 1.5rem;
        line-height: 1.1;
    }

    .hero-subtitle {
        font-size: 1.25rem;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 3rem;
        font-weight: 400;
    }

    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .stat-card {
        text-align: center;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        transition: all 0.3s;
    }

    .stat-card:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-4px);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 1rem;
        opacity: 0.9;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--accent-color);
    }

    .stat-label {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 600;
    }

    .content-area {
        padding: 3rem 2rem;
    }

    .section-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .section-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1rem;
        letter-spacing: -0.03em;
    }

    .section-subtitle {
        font-size: 1.125rem;
        color: var(--text-muted);
        max-width: 600px;
        margin: 0 auto;
    }

    .license-tabs {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2.5rem;
        flex-wrap: wrap;
    }

    .tab-button {
        padding: 1rem 2rem;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-dark);
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tab-button:hover {
        border-color: var(--accent-color);
        background: #fff5f1;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
    }

    .tab-button.active {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
        box-shadow: 0 4px 16px rgba(255, 107, 53, 0.3);
    }

    .tab-button.active:hover {
        background: #ff5722;
        transform: translateY(-2px);
    }

    .tab-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 24px;
        height: 24px;
        padding: 0 8px;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 700;
    }

    .tab-button .tab-count {
        background: #f3f4f6;
        color: var(--text-dark);
    }

    .tab-button.active .tab-count {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    .map-container {
        width: 100%;
        height: 600px;
        margin-bottom: 3rem;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--shadow-xl);
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .filters-section {
        background: var(--bg-section);
        padding: 2.5rem;
        border-radius: 16px;
        margin-bottom: 3rem;
    }

    .filters-section h5 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 2rem;
        letter-spacing: -0.03em;
    }

    .licenses-list {
        background: white;
        padding: 0;
    }

    .licenses-list h5 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 2rem;
        letter-spacing: -0.03em;
    }

    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 3rem;
        padding: 2rem 0;
    }

    .pagination-info {
        font-size: 0.95rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .pagination-btn {
        padding: 0.75rem 1.25rem;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-dark);
        cursor: pointer;
        transition: all 0.3s;
        min-width: 45px;
        text-align: center;
    }

    .pagination-btn:hover:not(:disabled) {
        border-color: var(--accent-color);
        background: #fff5f1;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
    }

    .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .pagination-btn.active {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }

    .pagination-ellipsis {
        padding: 0.75rem;
        color: var(--text-muted);
        font-weight: 600;
    }

    .license-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .license-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--accent-color);
    }

    .license-card-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1rem;
        letter-spacing: -0.02em;
    }

    .license-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .meta-icon {
        width: 32px;
        height: 32px;
        padding: 6px;
        background: var(--bg-section);
        border-radius: 8px;
        flex-shrink: 0;
    }

    .meta-content {
        flex: 1;
    }

    .meta-label {
        font-size: 0.75rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .meta-value {
        font-size: 1rem;
        color: var(--text-dark);
        font-weight: 600;
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-active {
        background-color: #d1fae5;
        color: var(--success-color);
    }

    .status-expired {
        background-color: #e5e5e5;
        color: #666666;
    }

    .status-suspended {
        background-color: #fef3c7;
        color: var(--warning-color);
    }

    .status-terminated {
        background-color: #fee2e2;
        color: var(--danger-color);
    }

    .filter-group {
        margin-bottom: 1.5rem;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: block;
        color: var(--text-dark);
        font-size: 0.9375rem;
    }

    .form-select, .form-control {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.2s;
        font-size: 1rem;
        background: white;
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        outline: none;
    }

    .btn {
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.2s;
        border: none;
        font-size: 1rem;
    }

    .btn-secondary {
        background-color: #e5e5e5;
        color: var(--text-dark);
    }

    .btn-secondary:hover {
        background-color: #d4d4d4;
        transform: translateY(-2px);
    }

    .btn-info {
        background-color: var(--info-color);
        color: white;
    }

    .btn-info:hover {
        background-color: #2563eb;
        transform: translateY(-2px);
    }

    .btn-primary {
        background-color: var(--accent-color);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--accent-hover);
        transform: translateY(-2px);
    }

    .legend {
        background: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        font-size: 0.9375rem;
        margin-bottom: 3rem;
        border: 1px solid var(--border-color);
    }

    .legend-title {
        font-weight: 700;
        margin-bottom: 1.25rem;
        font-size: 1.125rem;
        color: var(--text-dark);
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 2rem;
        margin-bottom: 0.75rem;
        font-weight: 500;
        color: var(--text-dark);
    }

    .legend-color {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        margin-right: 0.75rem;
        border: 2px solid rgba(0, 0, 0, 0.1);
    }

    .results-count {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 1rem;
    }

    .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: var(--shadow-xl);
    }

    .modal-header {
        background: linear-gradient(135deg, var(--text-dark) 0%, var(--primary-light) 100%);
        color: white;
        border-radius: 16px 16px 0 0;
        border-bottom: none;
        padding: 2rem;
    }

    .modal-title {
        font-weight: 700;
        font-size: 1.5rem;
        letter-spacing: -0.02em;
    }

    .modal-body {
        padding: 2.5rem;
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
        padding: 1.5rem 2rem;
        background: var(--bg-section);
        border-radius: 0 0 16px 16px;
    }

    .btn-close {
        filter: brightness(0) invert(1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Quick Navigation -->
<div class="quick-nav">
    <div class="quick-nav-container">
        <a href="#statistics" class="quick-nav-link">Статистика</a>
        <a href="#licenses" class="quick-nav-link">Лицензии</a>
        <a href="#map-section" class="quick-nav-link">Карта</a>
        <a href="/analytics/" class="quick-nav-link external">Аналитика</a>
    </div>
</div>

<!-- Back to Top Button -->
<button class="back-to-top" id="backToTop">
    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>
    </svg>
</button>

<div class="main-container">
    <!-- Hero Section -->
    <div class="hero-section" id="hero">
        <div class="container">
            <h1 class="hero-title">База лицензий на недропользование</h1>
            <p class="hero-subtitle">Интерактивная система управления и визуализации лицензий на право пользования недрами</p>
            
            <!-- Statistics Cards (динамически генерируются) -->
            <div class="stats-container" id="statistics"></div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Map Section -->
        <div class="section-header" style="margin-top: 4rem;" id="map-section">
            <h2 class="section-title">Интерактивная карта</h2>
            <p class="section-subtitle">Визуализация месторасположения лицензионных участков на интерактивной карте</p>
        </div>
        
        <!-- License Type Tabs (динамически генерируются) -->
        <div class="license-tabs" id="licenseTypeTabs"></div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>

        <!-- Legend (динамически генерируется) -->
        <div class="legend" id="mapLegend">
            <div class="legend-title">Цвета полигонов по виду пользования недрами</div>
            <div class="d-flex flex-wrap" id="legendItems"></div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <h5>Фильтры и поиск</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterStatus">Статус:</label>
                        <select id="filterStatus" class="form-select" onchange="applyFilters()">
                            <option value="">Все статусы</option>
                            <option value="active">Действующая</option>
                            <option value="expired">Истекла</option>
                            <option value="suspended">Приостановлена</option>
                            <option value="terminated">Прекращена</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterRegion">Регион:</label>
                        <select id="filterRegion" class="form-select" onchange="applyFilters()">
                            <option value="">Все регионы</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterType">Вид пользования:</label>
                        <select id="filterType" class="form-select" onchange="applyFilters()">
                            <option value="">Все виды</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterMineral">Полезное ископаемое:</label>
                        <select id="filterMineral" class="form-select" onchange="applyFilters()">
                            <option value="">Все виды</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="filter-group">
                        <label for="searchText">Поиск:</label>
                        <input type="text" id="searchText" class="form-control"
                            placeholder="Номер лицензии или недропользователь..." onkeyup="applyFilters()">
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <button class="btn btn-secondary btn-sm" onclick="resetFilters()">Сбросить фильтры</button>
                    <span class="ms-3 results-count" id="resultsCount"></span>
                </div>
                <button class="btn btn-primary export-btn" onclick="exportToExcel()">
                    <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                        <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
                        <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                    </svg>
                    Экспорт в Excel
                </button>
            </div>
        </div>

        <!-- Список лицензий -->
        <div class="licenses-list" id="licenses">
            <h5 class="mb-3">Список лицензий</h5>
            <div id="licensesList">
                <!-- Здесь будут карточки лицензий -->
            </div>
            
            <!-- Пагинация -->
            <div class="pagination-container" id="paginationContainer" style="display: none;">
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prevBtn" onclick="changePage('prev')">
                        ← Назад
                    </button>
                    <div id="pageNumbers" class="pagination-controls">
                        <!-- Номера страниц будут добавлены динамически -->
                    </div>
                    <button class="pagination-btn" id="nextBtn" onclick="changePage('next')">
                        Вперёд →
                    </button>
                </div>
                <div class="pagination-info" id="paginationInfo">
                    <!-- Информация о странице -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для детальной информации о лицензии -->
<div class="modal fade" id="licenseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Информация о лицензии</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Здесь будет отображаться детальная информация -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" onclick="showOnMap()">Показать на карте</button>
                {% if user.is_authenticated %}
                <button type="button" class="btn btn-primary" onclick="showUploadForm()">Загрузить документ</button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"
    type="text/javascript"></script>
<script>
    let currentLicenseId = null;
    let myMap;
    let allLicenses = [];
    let filteredLicenses = [];
    let placemarks = [];
    let currentPage = 1;
    let paginationData = null;
    let currentFiltersActive = false;
    const ITEMS_PER_PAGE = 12;

    ymaps.ready(init);

    function init() {
        myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 5,
            controls: ['zoomControl', 'searchControl', 'typeSelector', 'fullscreenControl']
        });

        loadLicenses();
    }

    function loadLicenses(page = 1) {
        currentPage = page;
        fetch(`/api/licenses/?page=${page}&page_size=12`)
            .then(response => response.json())
            .then(data => {
                console.log(`Загружено лицензий: ${data.results.length}`);
                
                // Сохраняем данные пагинации
                paginationData = data.pagination;
                
                // Если это первая загрузка, загружаем все лицензии для статистики и фильтров
                if (page === 1) {
                    loadAllLicensesForStats();
                }
                
                // Отображаем лицензии текущей страницы
                filteredLicenses = data.results;
                displayLicenses();
                displayLicensesOnMap();
                
                // Отображаем пагинацию
                displayPagination();
                
                // Обновляем счетчик результатов
                updateResultsCount();
            })
            .catch(error => console.error('Ошибка загрузки лицензий:', error));
    }
    
    function loadAllLicensesForStats() {
        // Загружаем ВСЕ лицензии для статистики без пагинации
        fetch('/api/licenses/all/')
            .then(response => response.json())
            .then(data => {
                allLicenses = data;
                
                try {
                    // Обновляем статистику
                    updateStatistics();
                    
                    // Генерируем динамические элементы
                    generateLicenseTypeTabs();
                    generateMapLegend();
                    
                    // Обновляем счетчики ПОСЛЕ создания кнопок
                    updateTabCounts();

                    // Заполняем фильтры уникальными значениями
                    populateFilters();
                    
                    // Обновляем карту, если фильтры не применены
                    if (!currentFiltersActive) {
                        displayLicensesOnMap();
                    }
                } catch (error) {
                    console.error('Ошибка в обработке данных:', error);
                    console.error('Stack trace:', error.stack);
                }
            })
            .catch(error => console.error('Ошибка загрузки статистики:', error));
    }
    
    function displayPagination() {
        const container = document.getElementById('paginationContainer');
        const pageNumbersDiv = document.getElementById('pageNumbers');
        const paginationInfo = document.getElementById('paginationInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        if (!paginationData || paginationData.total_pages <= 1) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'flex';
        
        // Обновляем кнопки Назад/Вперёд
        prevBtn.disabled = !paginationData.has_previous;
        nextBtn.disabled = !paginationData.has_next;
        
        // Информация о странице
        const start = (paginationData.current_page - 1) * 12 + 1;
        const end = Math.min(paginationData.current_page * 12, paginationData.total_count);
        paginationInfo.innerHTML = `Показано ${start}–${end} из ${paginationData.total_count}`;
        
        // Генерируем номера страниц
        pageNumbersDiv.innerHTML = '';
        const totalPages = paginationData.total_pages;
        const current = paginationData.current_page;
        
        // Логика отображения страниц
        let pages = [];
        
        if (totalPages <= 7) {
            // Показываем все страницы
            for (let i = 1; i <= totalPages; i++) {
                pages.push(i);
            }
        } else {
            // Показываем первую, последнюю и соседние
            pages.push(1);
            
            if (current > 3) {
                pages.push('...');
            }
            
            for (let i = Math.max(2, current - 1); i <= Math.min(totalPages - 1, current + 1); i++) {
                pages.push(i);
            }
            
            if (current < totalPages - 2) {
                pages.push('...');
            }
            
            pages.push(totalPages);
        }
        
        // Создаём кнопки
        pages.forEach(page => {
            if (page === '...') {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                pageNumbersDiv.appendChild(ellipsis);
            } else {
                const btn = document.createElement('button');
                btn.className = 'pagination-btn' + (page === current ? ' active' : '');
                btn.textContent = page;
                btn.onclick = () => changePage(page);
                pageNumbersDiv.appendChild(btn);
            }
        });
    }
    
    function changePage(direction) {
        if (currentFiltersActive) {
            // Клиентская пагинация (с фильтрами)
            let newPage;
            
            const totalPages = Math.ceil(filteredLicenses.length / ITEMS_PER_PAGE);
            
            if (direction === 'prev') {
                newPage = Math.max(1, currentPage - 1);
            } else if (direction === 'next') {
                newPage = Math.min(totalPages, currentPage + 1);
            } else {
                newPage = direction; // Номер страницы
            }
            
            displayFilteredPage(newPage);
        } else {
            // Серверная пагинация (без фильтров)
            let newPage;
            
            if (direction === 'prev') {
                newPage = paginationData.previous_page;
            } else if (direction === 'next') {
                newPage = paginationData.next_page;
            } else {
                newPage = direction; // Номер страницы
            }
            
            if (newPage) {
                loadLicenses(newPage);
            }
        }
        
        // Прокрутка наверх списка
        document.getElementById('licensesList').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function updatePagination(totalItems, currentPageNum, isFiltered) {
        const container = document.querySelector('.pagination-container');
        const pageNumbersDiv = document.getElementById('pageNumbers');
        const paginationInfo = document.getElementById('paginationInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        
        // Скрываем пагинацию если результатов мало
        if (totalItems <= ITEMS_PER_PAGE) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'flex';
        
        // Обновляем кнопки Назад/Вперёд
        prevBtn.disabled = currentPageNum <= 1;
        nextBtn.disabled = currentPageNum >= totalPages;
        
        // Информация о странице
        const start = (currentPageNum - 1) * ITEMS_PER_PAGE + 1;
        const end = Math.min(currentPageNum * ITEMS_PER_PAGE, totalItems);
        paginationInfo.innerHTML = `Показано ${start}–${end} из ${totalItems}`;
        
        // Генерируем номера страниц
        pageNumbersDiv.innerHTML = '';
        const current = currentPageNum;
        
        // Определяем диапазон страниц для отображения
        let startPage = Math.max(1, current - 2);
        let endPage = Math.min(totalPages, current + 2);
        
        // Корректируем диапазон, если мы близко к началу или концу
        if (current <= 3) {
            endPage = Math.min(5, totalPages);
        }
        if (current >= totalPages - 2) {
            startPage = Math.max(1, totalPages - 4);
        }
        
        // Первая страница
        if (startPage > 1) {
            const btn = document.createElement('button');
            btn.className = 'pagination-btn';
            btn.textContent = '1';
            btn.onclick = () => changePage(1);
            pageNumbersDiv.appendChild(btn);
            
            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                pageNumbersDiv.appendChild(ellipsis);
            }
        }
        
        // Страницы в диапазоне
        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.className = `pagination-btn ${i === current ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => changePage(i);
            pageNumbersDiv.appendChild(btn);
        }
        
        // Последняя страница
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                pageNumbersDiv.appendChild(ellipsis);
            }
            
            const btn = document.createElement('button');
            btn.className = 'pagination-btn';
            btn.textContent = totalPages;
            btn.onclick = () => changePage(totalPages);
            pageNumbersDiv.appendChild(btn);
        }
    }

    function updateStatistics() {
        const container = document.getElementById('statistics');
        if (!container) return;
        
        // Получаем статистику
        const totalCount = allLicenses.length;
        const activeCount = allLicenses.filter(l => l.status === 'active').length;
        const uniqueRegions = [...new Set(allLicenses.map(l => l.region))];
        const uniqueTypes = [...new Set(allLicenses.map(l => l.license_type))].sort();
        
        // Генерируем статистические карточки
        let html = `
            <div class="stat-card">
                <div class="stat-number">${totalCount}</div>
                <div class="stat-label">Всего лицензий</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${activeCount}</div>
                <div class="stat-label">Действующие</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${uniqueRegions.length}</div>
                <div class="stat-label">Регионов</div>
            </div>
        `;
        
        // Добавляем карточки для каждого типа недропользования
        uniqueTypes.forEach(type => {
            const count = allLicenses.filter(l => l.license_type === type).length;
            html += `
            <div class="stat-card">
                <div class="stat-number">${count}</div>
                <div class="stat-label">${type}</div>
            </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function updateTabCounts() {
        // Обновляем счетчик "Все"
        const countAllElement = document.getElementById('countAll');
        if (countAllElement) {
            countAllElement.textContent = allLicenses.length;
        }
        
        // Обновляем счетчики для каждого типа
        const uniqueTypes = [...new Set(allLicenses.map(l => l.license_type))].sort();
        uniqueTypes.forEach(type => {
            const count = allLicenses.filter(l => l.license_type === type).length;
            const countElement = document.getElementById(`count-${type}`);
            if (countElement) {
                countElement.textContent = count;
            }
        });
    }
    
    function generateLicenseTypeTabs() {
        const container = document.getElementById('licenseTypeTabs');
        if (!container) return;
        
        // Получаем уникальные типы лицензий
        const uniqueTypes = [...new Set(allLicenses.map(l => l.license_type))].sort();
        
        // Генерируем кнопки
        let html = `
            <button class="tab-button active" data-type="" onclick="filterByType('')">
                Все <span class="tab-count" id="countAll">0</span>
            </button>
        `;
        
        uniqueTypes.forEach(type => {
            html += `
            <button class="tab-button" data-type="${type}" onclick="filterByType('${type}')">
                ${type} <span class="tab-count" id="count-${type}">0</span>
            </button>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function generateMapLegend() {
        const container = document.getElementById('legendItems');
        if (!container) return;
        
        // Получаем уникальные типы лицензий
        const uniqueTypes = [...new Set(allLicenses.map(l => l.license_type))].sort();
        
        // Генерируем элементы легенды
        let html = '';
        uniqueTypes.forEach(type => {
            const color = getColorByUsageType(type);
            const description = getLicenseTypeDescription(type);
            html += `
                <div class="legend-item">
                    <span class="legend-color" style="background-color: ${color};"></span>
                    ${type} - ${description}
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function getLicenseTypeDescription(type) {
        // Здесь можно добавить описания для известных типов
        const descriptions = {
            'БЭ': 'Геологическое изучение с добычей',
            'БП': 'Добыча полезных ископаемых',
            'БР': 'Геологическое изучение',
            'ТП': 'Разведка и добыча'
        };
        return descriptions[type] || 'Пользование недрами';
    }
    
    function filterByType(type) {
        // Обновляем активный таб
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('.tab-button').classList.add('active');
        
        // Устанавливаем фильтр по типу
        document.getElementById('filterType').value = type;
        
        // Применяем фильтры
        applyFilters();
    }

    function populateFilters() {
        const regions = [...new Set(allLicenses.map(l => l.region))].sort();
        const types = [...new Set(allLicenses.map(l => l.license_type))].sort();
        const minerals = [...new Set(allLicenses.map(l => l.mineral_type).filter(m => m))].sort();

        const regionSelect = document.getElementById('filterRegion');
        // Очищаем старые опции, оставляя только первую ("Все регионы")
        while (regionSelect.options.length > 1) {
            regionSelect.remove(1);
        }
        regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.textContent = region;
            regionSelect.appendChild(option);
        });

        const typeSelect = document.getElementById('filterType');
        // Очищаем старые опции, оставляя только первую ("Все виды")
        while (typeSelect.options.length > 1) {
            typeSelect.remove(1);
        }
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
        });

        const mineralSelect = document.getElementById('filterMineral');
        // Очищаем старые опции, оставляя только первую ("Все виды")
        while (mineralSelect.options.length > 1) {
            mineralSelect.remove(1);
        }
        minerals.forEach(mineral => {
            const option = document.createElement('option');
            option.value = mineral;
            option.textContent = mineral;
            mineralSelect.appendChild(option);
        });
    }

    function applyFilters() {
        const statusFilter = document.getElementById('filterStatus').value;
        const regionFilter = document.getElementById('filterRegion').value;
        const typeFilter = document.getElementById('filterType').value;
        const mineralFilter = document.getElementById('filterMineral').value;
        const searchText = document.getElementById('searchText').value.toLowerCase();

        // Проверяем, применены ли фильтры
        const hasActiveFilters = statusFilter || regionFilter || typeFilter || mineralFilter || searchText;

        filteredLicenses = allLicenses.filter(license => {
            if (statusFilter && license.status !== statusFilter) return false;
            if (regionFilter && license.region !== regionFilter) return false;
            if (typeFilter && license.license_type !== typeFilter) return false;
            if (mineralFilter && license.mineral_type !== mineralFilter) return false;
            if (searchText && !license.license_number.toLowerCase().includes(searchText) &&
                !license.owner.toLowerCase().includes(searchText)) return false;
            return true;
        });

        if (hasActiveFilters) {
            // Переключаемся на клиентскую пагинацию
            currentFiltersActive = true;
            displayFilteredPage(1);
        } else {
            // Если фильтров нет, возвращаемся к серверной пагинации
            currentFiltersActive = false;
            loadLicenses(1);
        }
    }

    function resetFilters() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterRegion').value = '';
        document.getElementById('filterType').value = '';
        document.getElementById('filterMineral').value = '';
        document.getElementById('searchText').value = '';
        
        // Сбрасываем активный таб
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.tab-button[data-type=""]').classList.add('active');
        
        // Возвращаемся к серверной пагинации
        currentFiltersActive = false;
        loadLicenses(1);
    }
    
    function exportToExcel() {
        // Собираем текущие параметры фильтров
        const params = new URLSearchParams();
        
        const statusFilter = document.getElementById('filterStatus').value;
        const regionFilter = document.getElementById('filterRegion').value;
        const typeFilter = document.getElementById('filterType').value;
        const mineralFilter = document.getElementById('filterMineral').value;
        const searchText = document.getElementById('searchText').value;
        
        if (statusFilter) params.append('status', statusFilter);
        if (regionFilter) params.append('region', regionFilter);
        if (typeFilter) params.append('type', typeFilter);
        if (mineralFilter) params.append('mineral', mineralFilter);
        if (searchText) params.append('search', searchText);
        
        // Формируем URL для экспорта
        const exportUrl = `/api/licenses/export/excel/?${params.toString()}`;
        
        // Открываем ссылку для скачивания
        window.location.href = exportUrl;
    }

    function updateResultsCount() {
        const count = filteredLicenses.length;
        const total = allLicenses.length;
        document.getElementById('resultsCount').textContent = `Найдено: ${count} из ${total}`;
    }

    function displayLicenses() {
        const container = document.getElementById('licensesList');

        if (filteredLicenses.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-5">Лицензии не найдены</p>';
            return;
        }

        container.innerHTML = filteredLicenses.map(license => `
        <div class="license-card" onclick="showLicenseDetails(${license.id})">
            <div class="d-flex justify-content-between align-items-start">
                <div class="license-card-title">${license.license_number}</div>
                <span class="status-badge status-${license.status}">${getStatusText(license.status)}</span>
            </div>
            <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">${license.owner}</p>
            
            <div class="license-meta">
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Регион</div>
                        <div class="meta-value">${license.region}</div>
                    </div>
                </div>
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Тип</div>
                        <div class="meta-value">${license.license_type}</div>
                    </div>
                </div>
                ${license.mineral_type ? `
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Полезное ископаемое</div>
                        <div class="meta-value">${license.mineral_type}</div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `).join('');

        updateResultsCount();
    }

    function displayFilteredPage(pageNum) {
        currentPage = pageNum;
        
        const start = (pageNum - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pageData = filteredLicenses.slice(start, end);
        
        const container = document.getElementById('licensesList');
        
        if (filteredLicenses.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-5">Лицензии не найдены</p>';
            updatePagination(0, 1, true);
            return;
        }
        
        container.innerHTML = pageData.map(license => `
        <div class="license-card" onclick="showLicenseDetails(${license.id})">
            <div class="d-flex justify-content-between align-items-start">
                <div class="license-card-title">${license.license_number}</div>
                <span class="status-badge status-${license.status}">${getStatusText(license.status)}</span>
            </div>
            <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">${license.owner}</p>
            
            <div class="license-meta">
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Регион</div>
                        <div class="meta-value">${license.region}</div>
                    </div>
                </div>
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Тип</div>
                        <div class="meta-value">${license.license_type}</div>
                    </div>
                </div>
                ${license.mineral_type ? `
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Полезное ископаемое</div>
                        <div class="meta-value">${license.mineral_type}</div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
        `).join('');
        
        updatePagination(filteredLicenses.length, pageNum, true);
        displayLicensesOnMap();
        updateResultsCount();
    }

    function displayLicensesOnMap() {
        // Удаляем старые метки
        myMap.geoObjects.removeAll();
        placemarks = [];

        // Используем все лицензии если фильтры не применены, иначе только отфильтрованные
        const licensesToDisplay = currentFiltersActive ? filteredLicenses : allLicenses;

        licensesToDisplay.forEach(license => {
            let geoObject;

            // Проверяем, есть ли полигон
            if (license.polygon_data && license.polygon_data.coordinates) {
                const geomType = license.polygon_data.type;

                // GeoJSON использует [longitude, latitude], а Яндекс [latitude, longitude]
                if (geomType === 'Polygon') {
                    // Простой полигон - конвертируем координаты
                    const convertedCoords = license.polygon_data.coordinates.map(ring =>
                        ring.map(coord => [coord[1], coord[0]])
                    );
                    geoObject = new ymaps.Polygon(
                        convertedCoords,
                        {
                            balloonContentHeader: `<strong>${license.license_number}</strong>`,
                            balloonContentBody: `
                        <div class="license-info">
                            <p><strong>Недропользователь:</strong> ${license.owner}</p>
                            <p><strong>Регион:</strong> ${license.region}</p>
                            <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                            <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                Подробнее
                            </button>
                        </div>
                    `,
                            hintContent: license.license_number
                        },
                        {
                            fillColor: getColorByUsageType(license.license_type),
                            fillOpacity: 0.3,
                            strokeColor: getColorByUsageType(license.license_type),
                            strokeWidth: 2,
                            strokeOpacity: 0.8
                        }
                    );
                } else if (geomType === 'MultiPolygon') {
                    // MultiPolygon - создаем коллекцию полигонов
                    const collection = new ymaps.GeoObjectCollection();
                    license.polygon_data.coordinates.forEach(polygonCoords => {
                        const convertedCoords = polygonCoords.map(ring =>
                            ring.map(coord => [coord[1], coord[0]])
                        );
                        const polygon = new ymaps.Polygon(
                            convertedCoords,
                            {
                                balloonContentHeader: `<strong>${license.license_number}</strong>`,
                                balloonContentBody: `
                                <div class="license-info">
                                    <p><strong>Недропользователь:</strong> ${license.owner}</p>
                                    <p><strong>Регион:</strong> ${license.region}</p>
                                    <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                                    <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                                    <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                        Подробнее
                                    </button>
                                </div>
                            `,
                                hintContent: license.license_number
                            },
                            {
                                fillColor: getColorByUsageType(license.license_type),
                                fillOpacity: 0.3,
                                strokeColor: getColorByUsageType(license.license_type),
                                strokeWidth: 2,
                                strokeOpacity: 0.8
                            }
                        );
                        collection.add(polygon);
                    });
                    geoObject = collection;
                }
            } else if (license.latitude && license.longitude) {
                // Создаём точку (для обратной совместимости)
                geoObject = new ymaps.Placemark(
                    [license.latitude, license.longitude],
                    {
                        balloonContentHeader: `<strong>${license.license_number}</strong>`,
                        balloonContentBody: `
                        <div class="license-info">
                            <p><strong>Недропользователь:</strong> ${license.owner}</p>
                            <p><strong>Регион:</strong> ${license.region}</p>
                            <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                            <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                Подробнее
                            </button>
                        </div>
                    `,
                        hintContent: license.license_number
                    },
                    {
                        preset: getPresetByUsageType(license.license_type)
                    }
                );
            }

            if (geoObject) {
                myMap.geoObjects.add(geoObject);
                placemarks.push(geoObject);
            }
        });

        console.log(`Отображено объектов на карте: ${placemarks.length}`);

        // Автоматически подстраиваем границы карты под объекты
        if (placemarks.length > 0) {
            try {
                const bounds = myMap.geoObjects.getBounds();
                console.log('Границы объектов:', bounds);
                myMap.setBounds(bounds, {
                    checkZoomRange: true,
                    zoomMargin: 100,
                    duration: 500
                });
            } catch (e) {
                console.error('Ошибка установки границ:', e);
            }
        } else {
            console.warn('Нет объектов для отображения на карте');
        }
    }

    function getColorByUsageType(usageType) {
        const colors = {
            'БЭ': '#3498db',
            'БП': '#27ae60',
            'БР': '#e67e22',
            'ТП': '#1abc9c',
            'ПВ': '#9b59b6',
            'ГС': '#f39c12',
            'КП': '#e74c3c',
            'РП': '#16a085',
            'СП': '#8e44ad',
            'УВС': '#2c3e50'
        };
        return colors[usageType] || '#95a5a6';
    }

    function getColorByStatus(status) {
        const colors = {
            'active': '#28a745',
            'expired': '#6c757d',
            'suspended': '#ffc107',
            'terminated': '#dc3545'
        };
        return colors[status] || '#007bff';
    }

    function getStatusText(status) {
        const statuses = {
            'active': 'Действующая',
            'expired': 'Истекла',
            'suspended': 'Приостановлена',
            'terminated': 'Прекращена'
        };
        return statuses[status] || status;
    }

    function getPresetByUsageType(usageType) {
        const presets = {
            'БЭ': 'islands#blueDotIcon',
            'БП': 'islands#greenDotIcon',
            'БР': 'islands#orangeDotIcon',
            'ТП': 'islands#lightBlueDotIcon',
            'ПВ': 'islands#violetDotIcon',
            'ГС': 'islands#yellowDotIcon',
            'КП': 'islands#redDotIcon',
            'РП': 'islands#darkGreenDotIcon',
            'СП': 'islands#darkBlueDotIcon',
            'УВС': 'islands#grayDotIcon'
        };
        return presets[usageType] || 'islands#grayDotIcon';
    }

    function getPresetByStatus(status) {
        const presets = {
            'active': 'islands#greenDotIcon',
            'expired': 'islands#grayDotIcon',
            'suspended': 'islands#yellowDotIcon',
            'terminated': 'islands#redDotIcon'
        };
        return presets[status] || 'islands#blueDotIcon';
    }

    let currentLicense = null;

    function showLicenseDetails(licenseId) {
        currentLicenseId = licenseId;
        fetch(`/api/licenses/${licenseId}/`)
            .then(response => response.json())
            .then(license => {
                currentLicense = license;
                document.getElementById('modalTitle').innerHTML = `Лицензия ${license.license_number}`;

                let documentsHtml = '';
                if (license.documents && license.documents.length > 0) {
                    documentsHtml = '<h6 class="mt-3">Документы:</h6><ul class="list-group">';
                    license.documents.forEach(doc => {
                        documentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${doc.title}
                            <a href="/api/documents/${doc.id}/download/" class="btn btn-sm btn-outline-primary">
                                Скачать
                            </a>
                        </li>
                    `;
                    });
                    documentsHtml += '</ul>';
                } else {
                    documentsHtml = '<p class="text-muted mt-3">Нет прикрепленных документов</p>';
                }

                document.getElementById('modalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Номер лицензии:</strong> ${license.license_number}</p>
                        <p><strong>Недропользователь:</strong> ${license.owner}</p>
                        <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                        <p><strong>Регион:</strong> ${license.region}</p>
                        <p><strong>Участок недр:</strong> ${license.area || 'Не указан'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Дата выдачи:</strong> ${license.issue_date}</p>
                        <p><strong>Дата окончания:</strong> ${license.expiry_date || 'Не указана'}</p>
                        <p><strong>Полезное ископаемое:</strong> ${license.mineral_type || 'Не указано'}</p>
                        <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                        <p><strong>Координаты:</strong> ${license.latitude}, ${license.longitude}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Описание:</strong></p>
                        <p>${license.description || 'Нет описания'}</p>
                    </div>
                </div>
                ${documentsHtml}
            `;

                const modal = new bootstrap.Modal(document.getElementById('licenseModal'));
                modal.show();
            })
            .catch(error => console.error('Ошибка загрузки деталей лицензии:', error));
    }

    function showUploadForm() {
        if (!currentLicenseId) {
            alert('Лицензия не выбрана');
            return;
        }

        const fileInput = document.createElement('input');

        fileInput.type = 'file';
        fileInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.jpg,.png';

        fileInput.onchange = () => {
            if (fileInput.files.length === 0) return;

            const selectedFile = fileInput.files[0];
            const defaultTitle = selectedFile.name;

            const title = prompt('Название документа:', defaultTitle);
            if (!title) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('title', title);
            formData.append('file_type', 'other');

            fetch(`/api/licenses/${currentLicenseId}/upload/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Документ успешно загружен');
                        showLicenseDetails(currentLicenseId);
                    } else {
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки документа:', error);
                    alert('Ошибка загрузки документа');
                });
        };

        fileInput.click();
    }

    function showOnMap() {
        if (!currentLicense) {
            alert('Лицензия не загружена');
            return;
        }

        // Закрываем модальное окно
        const modal = bootstrap.Modal.getInstance(document.getElementById('licenseModal'));
        modal.hide();

        // Прокручиваем к карте
        document.querySelector('.map-container').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        // Центрируем карту на точном местоположении лицензии с увеличенным зумом
        setTimeout(() => {
            myMap.setCenter([currentLicense.latitude, currentLicense.longitude], 15, {
                checkZoomRange: true,
                duration: 500
            });

            // Находим соответствующий маркер по ID лицензии и открываем его балун
            setTimeout(() => {
                const placemarkIndex = filteredLicenses.findIndex(license => license.id === currentLicense.id);

                if (placemarkIndex !== -1 && placemarks[placemarkIndex]) {
                    placemarks[placemarkIndex].balloon.open();
                }
            }, 600);
        }, 300);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Back to top button functionality
    const backToTopButton = document.getElementById('backToTop');
    
    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
            backToTopButton.classList.add('show');
        } else {
            backToTopButton.classList.remove('show');
        }
    });

    backToTopButton.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
</script>
{% endblock %}