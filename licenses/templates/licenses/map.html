{% extends 'licenses/base.html' %}

{% block title %}Карта лицензий{% endblock %}

{% block extra_css %}
<style>
    body {
        overflow-y: auto;
        background: var(--primary-dark);
    }

    .main-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
        min-height: calc(100vh - 65px);
        padding: 20px;
        max-width: 100%;
    }

    @media (max-width: 1200px) {
        .main-container {
            grid-template-columns: 1fr;
        }
    }

    .map-section {
        position: relative;
        background: var(--secondary-dark);
        border: 1px solid var(--border-color);
    }

    #map {
        width: 100%;
        height: calc(100vh - 105px);
        min-height: 500px;
    }

    .controls-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-height: calc(100vh - 105px);
        overflow-y: auto;
    }

    .control-block {
        background: var(--secondary-dark);
        border: 1px solid var(--border-color);
        padding: 20px;
    }

    .control-block h3 {
        color: var(--text-primary);
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
    }

    .legend-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border: 1px solid var(--border-color);
    }

    .filter-group {
        margin-bottom: 16px;
    }

    .filter-group label {
        display: block;
        color: var(--text-secondary);
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .form-select, .form-control {
        background: var(--tertiary-dark);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 10px 12px;
        font-size: 13px;
        transition: all 0.2s;
    }

    .form-select:focus, .form-control:focus {
        background: var(--secondary-dark);
        border-color: var(--accent-cyan);
        color: var(--text-primary);
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        outline: none;
    }

    .form-select option {
        background: var(--tertiary-dark);
        color: var(--text-primary);
    }

    .btn-reset {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s;
        cursor: pointer;
    }

    .btn-reset:hover {
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
    }

    .results-count {
        color: var(--text-secondary);
        font-size: 12px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
    }

    .licenses-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .license-card {
        background: var(--tertiary-dark);
        border: 1px solid var(--border-color);
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .license-card:hover {
        border-color: var(--accent-cyan);
        background: var(--secondary-dark);
    }

    .license-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .license-number {
        color: var(--text-primary);
        font-size: 14px;
        font-weight: 700;
        font-family: 'Courier New', monospace;
    }

    .status-badge {
        padding: 4px 10px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid;
    }

    .status-active {
        color: #10b981;
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.1);
    }

    .status-expired {
        color: #6b7280;
        border-color: #6b7280;
        background: rgba(107, 114, 128, 0.1);
    }

    .status-suspended {
        color: #f59e0b;
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.1);
    }

    .status-terminated {
        color: #ef4444;
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    .license-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .license-row {
        display: flex;
        font-size: 12px;
    }

    .license-label {
        color: var(--text-secondary);
        min-width: 80px;
    }

    .license-value {
        color: var(--text-primary);
    }

    .modal-content {
        background: var(--secondary-dark);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
        font-size: 16px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
    }

    .btn-close {
        filter: invert(1);
    }

    .btn {
        padding: 10px 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid var(--border-color);
        transition: all 0.2s;
    }

    .btn-primary {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
    }

    .btn-primary:hover {
        background: #1d4ed8;
        border-color: #1d4ed8;
    }

    .btn-info {
        background: var(--accent-cyan);
        border-color: var(--accent-cyan);
        color: var(--primary-dark);
    }

    .btn-info:hover {
        background: #0891b2;
        border-color: #0891b2;
    }

    .btn-secondary {
        background: transparent;
        color: var(--text-secondary);
    }

    .btn-secondary:hover {
        background: var(--tertiary-dark);
        color: var(--text-primary);
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--primary-dark);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--border-color);
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--accent-steel);
    }

    .no-licenses {
        color: var(--text-secondary);
        text-align: center;
        padding: 40px 20px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="map-section">
        <div id="map"></div>
    </div>

    <div class="controls-section">
        <div class="control-block">
            <h3>Легенда</h3>
            <div class="legend-grid">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #3498db;"></span>
                    <span>БЭ</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #27ae60;"></span>
                    <span>БП</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #e67e22;"></span>
                    <span>БР</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #1abc9c;"></span>
                    <span>ТП</span>
                </div>
            </div>
        </div>

        <div class="control-block">
            <h3>Фильтры</h3>
            <div class="filter-group">
                <label for="filterStatus">Статус</label>
                <select id="filterStatus" class="form-select" onchange="applyFilters()">
                    <option value="">Все</option>
                    <option value="active">Действующая</option>
                    <option value="expired">Истекла</option>
                    <option value="suspended">Приостановлена</option>
                    <option value="terminated">Прекращена</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filterRegion">Регион</label>
                <select id="filterRegion" class="form-select" onchange="applyFilters()">
                    <option value="">Все</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filterType">Вид пользования</label>
                <select id="filterType" class="form-select" onchange="applyFilters()">
                    <option value="">Все</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filterMineral">Полезное ископаемое</label>
                <select id="filterMineral" class="form-select" onchange="applyFilters()">
                    <option value="">Все</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="searchText">Поиск</label>
                <input type="text" id="searchText" class="form-control"
                    placeholder="Номер или недропользователь" onkeyup="applyFilters()">
            </div>

            <button class="btn-reset" onclick="resetFilters()">Сбросить</button>
            <div class="results-count" id="resultsCount"></div>
        </div>

        <div class="control-block">
            <h3>Лицензии</h3>
            <div class="licenses-list" id="licensesList">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="licenseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Информация о лицензии</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" onclick="showOnMap()">Показать на карте</button>
                {% if user.is_authenticated %}
                <button type="button" class="btn btn-primary" onclick="showUploadForm()">Загрузить документ</button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"
    type="text/javascript"></script>
<script>
    let currentLicenseId = null;
    let myMap;
    let allLicenses = [];
    let filteredLicenses = [];
    let placemarks = [];

    ymaps.ready(init);

    function init() {
        myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 5,
            controls: ['zoomControl', 'searchControl', 'typeSelector', 'fullscreenControl']
        });

        loadLicenses();
    }

    function loadLicenses() {
        fetch('/api/licenses/')
            .then(response => response.json())
            .then(data => {
                console.log(`Загружено лицензий: ${data.length}`);
                allLicenses = data;
                filteredLicenses = data;

                populateFilters();
                displayLicenses();
                displayLicensesOnMap();
            })
            .catch(error => console.error('Ошибка загрузки лицензий:', error));
    }

    function populateFilters() {
        const regions = [...new Set(allLicenses.map(l => l.region))].sort();
        const types = [...new Set(allLicenses.map(l => l.license_type))].sort();
        const minerals = [...new Set(allLicenses.map(l => l.mineral_type).filter(m => m))].sort();

        const regionSelect = document.getElementById('filterRegion');
        regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.textContent = region;
            regionSelect.appendChild(option);
        });

        const typeSelect = document.getElementById('filterType');
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
        });

        const mineralSelect = document.getElementById('filterMineral');
        minerals.forEach(mineral => {
            const option = document.createElement('option');
            option.value = mineral;
            option.textContent = mineral;
            mineralSelect.appendChild(option);
        });
    }

    function applyFilters() {
        const statusFilter = document.getElementById('filterStatus').value;
        const regionFilter = document.getElementById('filterRegion').value;
        const typeFilter = document.getElementById('filterType').value;
        const mineralFilter = document.getElementById('filterMineral').value;
        const searchText = document.getElementById('searchText').value.toLowerCase();

        filteredLicenses = allLicenses.filter(license => {
            if (statusFilter && license.status !== statusFilter) return false;
            if (regionFilter && license.region !== regionFilter) return false;
            if (typeFilter && license.license_type !== typeFilter) return false;
            if (mineralFilter && license.mineral_type !== mineralFilter) return false;
            if (searchText && !license.license_number.toLowerCase().includes(searchText) &&
                !license.owner.toLowerCase().includes(searchText)) return false;
            return true;
        });

        displayLicenses();
        displayLicensesOnMap();
        updateResultsCount();
    }

    function resetFilters() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterRegion').value = '';
        document.getElementById('filterType').value = '';
        document.getElementById('filterMineral').value = '';
        document.getElementById('searchText').value = '';
        applyFilters();
    }

    function updateResultsCount() {
        const count = filteredLicenses.length;
        const total = allLicenses.length;
        document.getElementById('resultsCount').textContent = `Показано: ${count} / ${total}`;
    }

    function displayLicenses() {
        const container = document.getElementById('licensesList');

        if (filteredLicenses.length === 0) {
            container.innerHTML = '<div class="no-licenses">Лицензии не найдены</div>';
            return;
        }

        container.innerHTML = filteredLicenses.map(license => `
        <div class="license-card" onclick="showLicenseDetails(${license.id})">
            <div class="license-header">
                <div class="license-number">${license.license_number}</div>
                <span class="status-badge status-${license.status}">${getStatusText(license.status)}</span>
            </div>
            <div class="license-info">
                <div class="license-row">
                    <div class="license-label">Компания:</div>
                    <div class="license-value">${license.owner}</div>
                </div>
                <div class="license-row">
                    <div class="license-label">Регион:</div>
                    <div class="license-value">${license.region}</div>
                </div>
                <div class="license-row">
                    <div class="license-label">Тип:</div>
                    <div class="license-value">${license.license_type}</div>
                </div>
            </div>
        </div>
    `).join('');

        updateResultsCount();
    }

    function displayLicensesOnMap() {
        myMap.geoObjects.removeAll();
        placemarks = [];

        filteredLicenses.forEach(license => {
            let geoObject;

            if (license.polygon_data && license.polygon_data.coordinates) {
                const geomType = license.polygon_data.type;

                if (geomType === 'Polygon') {
                    const convertedCoords = license.polygon_data.coordinates.map(ring =>
                        ring.map(coord => [coord[1], coord[0]])
                    );
                    geoObject = new ymaps.Polygon(
                        convertedCoords,
                        {
                            balloonContentHeader: `<strong>${license.license_number}</strong>`,
                            balloonContentBody: `
                            <div style="color: #000;">
                                <p><strong>Недропользователь:</strong> ${license.owner}</p>
                                <p><strong>Регион:</strong> ${license.region}</p>
                                <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                                <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                                <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                    Подробнее
                                </button>
                            </div>
                        `,
                            hintContent: license.license_number
                        },
                        {
                            fillColor: getColorByUsageType(license.license_type),
                            fillOpacity: 0.3,
                            strokeColor: getColorByUsageType(license.license_type),
                            strokeWidth: 2,
                            strokeOpacity: 0.8
                        }
                    );
                } else if (geomType === 'MultiPolygon') {
                    const collection = new ymaps.GeoObjectCollection();
                    license.polygon_data.coordinates.forEach(polygonCoords => {
                        const convertedCoords = polygonCoords.map(ring =>
                            ring.map(coord => [coord[1], coord[0]])
                        );
                        const polygon = new ymaps.Polygon(
                            convertedCoords,
                            {
                                balloonContentHeader: `<strong>${license.license_number}</strong>`,
                                balloonContentBody: `
                                    <div style="color: #000;">
                                        <p><strong>Недропользователь:</strong> ${license.owner}</p>
                                        <p><strong>Регион:</strong> ${license.region}</p>
                                        <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                                        <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                                        <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                            Подробнее
                                        </button>
                                    </div>
                                `,
                                hintContent: license.license_number
                            },
                            {
                                fillColor: getColorByUsageType(license.license_type),
                                fillOpacity: 0.3,
                                strokeColor: getColorByUsageType(license.license_type),
                                strokeWidth: 2,
                                strokeOpacity: 0.8
                            }
                        );
                        collection.add(polygon);
                    });
                    geoObject = collection;
                }
            } else if (license.latitude && license.longitude) {
                geoObject = new ymaps.Placemark(
                    [license.latitude, license.longitude],
                    {
                        balloonContentHeader: `<strong>${license.license_number}</strong>`,
                        balloonContentBody: `
                        <div style="color: #000;">
                            <p><strong>Недропользователь:</strong> ${license.owner}</p>
                            <p><strong>Регион:</strong> ${license.region}</p>
                            <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                            <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                Подробнее
                            </button>
                        </div>
                    `,
                        hintContent: license.license_number
                    },
                    {
                        preset: getPresetByUsageType(license.license_type)
                    }
                );
            }

            if (geoObject) {
                myMap.geoObjects.add(geoObject);
                placemarks.push(geoObject);
            }
        });

        console.log(`Отображено объектов на карте: ${placemarks.length}`);

        if (placemarks.length > 0) {
            try {
                const bounds = myMap.geoObjects.getBounds();
                console.log('Границы объектов:', bounds);
                myMap.setBounds(bounds, {
                    checkZoomRange: true,
                    zoomMargin: 50,
                    duration: 500
                });
            } catch (e) {
                console.error('Ошибка установки границ:', e);
            }
        } else {
            console.warn('Нет объектов для отображения на карте');
        }
    }

    function getColorByUsageType(usageType) {
        const colors = {
            'БЭ': '#3498db',
            'БП': '#27ae60',
            'БР': '#e67e22',
            'ТП': '#1abc9c',
            'ПВ': '#9b59b6',
            'ГС': '#f39c12',
            'КП': '#e74c3c',
            'РП': '#16a085',
            'СП': '#8e44ad',
            'УВС': '#2c3e50'
        };
        return colors[usageType] || '#95a5a6';
    }

    function getStatusText(status) {
        const statuses = {
            'active': 'Действует',
            'expired': 'Истекла',
            'suspended': 'Приостановлена',
            'terminated': 'Прекращена'
        };
        return statuses[status] || status;
    }

    function getPresetByUsageType(usageType) {
        const presets = {
            'БЭ': 'islands#blueDotIcon',
            'БП': 'islands#greenDotIcon',
            'БР': 'islands#orangeDotIcon',
            'ТП': 'islands#lightBlueDotIcon',
            'ПВ': 'islands#violetDotIcon',
            'ГС': 'islands#yellowDotIcon',
            'КП': 'islands#redDotIcon',
            'РП': 'islands#darkGreenDotIcon',
            'СП': 'islands#darkBlueDotIcon',
            'УВС': 'islands#grayDotIcon'
        };
        return presets[usageType] || 'islands#grayDotIcon';
    }

    let currentLicense = null;

    function showLicenseDetails(licenseId) {
        currentLicenseId = licenseId;
        fetch(`/api/licenses/${licenseId}/`)
            .then(response => response.json())
            .then(license => {
                currentLicense = license;
                document.getElementById('modalTitle').innerHTML = license.license_number;

                let documentsHtml = '';
                if (license.documents && license.documents.length > 0) {
                    documentsHtml = `
                        <div style="margin-top: 20px;">
                            <h6 style="color: var(--text-primary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Документы</h6>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${license.documents.map(doc => `
                                    <a href="/api/documents/${doc.id}/download/" 
                                       style="color: var(--accent-cyan); text-decoration: none; font-size: 13px; padding: 8px; background: var(--tertiary-dark); border: 1px solid var(--border-color);">
                                        ${doc.name} (${doc.type})
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                document.getElementById('modalBody').innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: 12px; font-size: 13px;">
                            <div style="color: var(--text-secondary);">Номер лицензии:</div>
                            <div style="color: var(--text-primary); font-weight: 700; font-family: 'Courier New', monospace;">${license.license_number}</div>
                            
                            <div style="color: var(--text-secondary);">Статус:</div>
                            <div><span class="status-badge status-${license.status}">${getStatusText(license.status)}</span></div>
                            
                            <div style="color: var(--text-secondary);">Недропользователь:</div>
                            <div style="color: var(--text-primary);">${license.owner}</div>
                            
                            <div style="color: var(--text-secondary);">Вид пользования:</div>
                            <div style="color: var(--text-primary);">${license.license_type}</div>
                            
                            <div style="color: var(--text-secondary);">Регион:</div>
                            <div style="color: var(--text-primary);">${license.region}</div>
                            
                            <div style="color: var(--text-secondary);">Участок недр:</div>
                            <div style="color: var(--text-primary);">${license.area || '-'}</div>
                            
                            ${license.mineral_type ? `
                            <div style="color: var(--text-secondary);">Полезное ископаемое:</div>
                            <div style="color: var(--text-primary);">${license.mineral_type}</div>
                            ` : ''}
                            
                            <div style="color: var(--text-secondary);">Дата выдачи:</div>
                            <div style="color: var(--text-primary);">${license.issue_date || '-'}</div>
                            
                            <div style="color: var(--text-secondary);">Дата окончания:</div>
                            <div style="color: var(--text-primary);">${license.expiry_date || '-'}</div>
                        </div>
                        
                        ${license.description ? `
                        <div>
                            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Описание:</div>
                            <div style="color: var(--text-primary); font-size: 13px; line-height: 1.6;">${license.description}</div>
                        </div>
                        ` : ''}
                        
                        ${documentsHtml}
                    </div>
                `;

                const modal = new bootstrap.Modal(document.getElementById('licenseModal'));
                modal.show();
            })
            .catch(error => console.error('Ошибка загрузки деталей лицензии:', error));
    }

    function showOnMap() {
        if (currentLicense) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('licenseModal'));
            modal.hide();

            if (currentLicense.latitude && currentLicense.longitude) {
                myMap.setCenter([currentLicense.latitude, currentLicense.longitude], 12);
            } else if (currentLicense.polygon_data && currentLicense.polygon_data.coordinates) {
                const bounds = myMap.geoObjects.getBounds();
                myMap.setBounds(bounds, {
                    checkZoomRange: true,
                    zoomMargin: 100
                });
            }
        }
    }

    function showUploadForm() {
        alert('Функция загрузки документов в разработке');
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
