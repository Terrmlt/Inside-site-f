{% extends 'licenses/base.html' %}

{% block title %}Интерактивная карта лицензий{% endblock %}

{% block extra_css %}
<style>
    body {
        overflow-y: auto;
        background-color: #ffffff;
    }

    .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0;
    }

    .hero-section {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: white;
        padding: 4rem 2rem 3rem;
        position: relative;
    }

    .hero-title {
        font-size: 3.5rem;
        font-weight: 700;
        letter-spacing: -0.04em;
        margin-bottom: 1.5rem;
        line-height: 1.1;
    }

    .hero-subtitle {
        font-size: 1.25rem;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 3rem;
        font-weight: 400;
    }

    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .stat-card {
        text-align: center;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        transition: all 0.3s;
    }

    .stat-card:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-4px);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 1rem;
        opacity: 0.9;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--accent-color);
    }

    .stat-label {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 600;
    }

    .content-area {
        padding: 3rem 2rem;
    }

    .section-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .section-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1rem;
        letter-spacing: -0.03em;
    }

    .section-subtitle {
        font-size: 1.125rem;
        color: var(--text-muted);
        max-width: 600px;
        margin: 0 auto;
    }

    .map-container {
        width: 100%;
        height: 600px;
        margin-bottom: 3rem;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--shadow-xl);
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .filters-section {
        background: var(--bg-section);
        padding: 2.5rem;
        border-radius: 16px;
        margin-bottom: 3rem;
    }

    .filters-section h5 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 2rem;
        letter-spacing: -0.03em;
    }

    .licenses-list {
        background: white;
        padding: 0;
    }

    .licenses-list h5 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 2rem;
        letter-spacing: -0.03em;
    }

    .license-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .license-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--accent-color);
    }

    .license-card-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1rem;
        letter-spacing: -0.02em;
    }

    .license-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .meta-icon {
        width: 32px;
        height: 32px;
        padding: 6px;
        background: var(--bg-section);
        border-radius: 8px;
        flex-shrink: 0;
    }

    .meta-content {
        flex: 1;
    }

    .meta-label {
        font-size: 0.75rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .meta-value {
        font-size: 1rem;
        color: var(--text-dark);
        font-weight: 600;
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-active {
        background-color: #d1fae5;
        color: var(--success-color);
    }

    .status-expired {
        background-color: #e5e5e5;
        color: #666666;
    }

    .status-suspended {
        background-color: #fef3c7;
        color: var(--warning-color);
    }

    .status-terminated {
        background-color: #fee2e2;
        color: var(--danger-color);
    }

    .filter-group {
        margin-bottom: 1.5rem;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: block;
        color: var(--text-dark);
        font-size: 0.9375rem;
    }

    .form-select, .form-control {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.2s;
        font-size: 1rem;
        background: white;
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        outline: none;
    }

    .btn {
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.2s;
        border: none;
        font-size: 1rem;
    }

    .btn-secondary {
        background-color: #e5e5e5;
        color: var(--text-dark);
    }

    .btn-secondary:hover {
        background-color: #d4d4d4;
        transform: translateY(-2px);
    }

    .btn-info {
        background-color: var(--info-color);
        color: white;
    }

    .btn-info:hover {
        background-color: #2563eb;
        transform: translateY(-2px);
    }

    .btn-primary {
        background-color: var(--accent-color);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--accent-hover);
        transform: translateY(-2px);
    }

    .legend {
        background: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        font-size: 0.9375rem;
        margin-bottom: 3rem;
        border: 1px solid var(--border-color);
    }

    .legend-title {
        font-weight: 700;
        margin-bottom: 1.25rem;
        font-size: 1.125rem;
        color: var(--text-dark);
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 2rem;
        margin-bottom: 0.75rem;
        font-weight: 500;
        color: var(--text-dark);
    }

    .legend-color {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        margin-right: 0.75rem;
        border: 2px solid rgba(0, 0, 0, 0.1);
    }

    .results-count {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 1rem;
    }

    .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: var(--shadow-xl);
    }

    .modal-header {
        background: linear-gradient(135deg, var(--text-dark) 0%, var(--primary-light) 100%);
        color: white;
        border-radius: 16px 16px 0 0;
        border-bottom: none;
        padding: 2rem;
    }

    .modal-title {
        font-weight: 700;
        font-size: 1.5rem;
        letter-spacing: -0.02em;
    }

    .modal-body {
        padding: 2.5rem;
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
        padding: 1.5rem 2rem;
        background: var(--bg-section);
        border-radius: 0 0 16px 16px;
    }

    .btn-close {
        filter: brightness(0) invert(1);
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <h1 class="hero-title">База лицензий на недропользование</h1>
            <p class="hero-subtitle">Интерактивная система управления и визуализации лицензий на право пользования недрами</p>
            
            <!-- Statistics Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">-</div>
                    <div class="stat-label">Всего лицензий</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeCount">-</div>
                    <div class="stat-label">Действующие</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="regionCount">-</div>
                    <div class="stat-label">Регионов</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="typeCount">-</div>
                    <div class="stat-label">Типов недропользования</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Map Section -->
        <div class="section-header">
            <h2 class="section-title">Интерактивная карта</h2>
            <p class="section-subtitle">Визуализация месторасположения лицензионных участков на интерактивной карте</p>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-title">Цвета полигонов по виду пользования недрами</div>
            <div class="d-flex flex-wrap">
                <div class="legend-item"><span class="legend-color" style="background-color: #3498db;"></span>БЭ - Геологическое изучение с добычей</div>
                <div class="legend-item"><span class="legend-color" style="background-color: #27ae60;"></span>БП - Добыча полезных ископаемых</div>
                <div class="legend-item"><span class="legend-color" style="background-color: #e67e22;"></span>БР - Геологическое изучение</div>
                <div class="legend-item"><span class="legend-color" style="background-color: #1abc9c;"></span>ТП - Разведка и добыча</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <h5>Фильтры и поиск</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterStatus">Статус:</label>
                        <select id="filterStatus" class="form-select" onchange="applyFilters()">
                            <option value="">Все статусы</option>
                            <option value="active">Действующая</option>
                            <option value="expired">Истекла</option>
                            <option value="suspended">Приостановлена</option>
                            <option value="terminated">Прекращена</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterRegion">Регион:</label>
                        <select id="filterRegion" class="form-select" onchange="applyFilters()">
                            <option value="">Все регионы</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterType">Вид пользования:</label>
                        <select id="filterType" class="form-select" onchange="applyFilters()">
                            <option value="">Все виды</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterMineral">Полезное ископаемое:</label>
                        <select id="filterMineral" class="form-select" onchange="applyFilters()">
                            <option value="">Все виды</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="filter-group">
                        <label for="searchText">Поиск:</label>
                        <input type="text" id="searchText" class="form-control"
                            placeholder="Номер лицензии или недропользователь..." onkeyup="applyFilters()">
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="resetFilters()">Сбросить фильтры</button>
            <span class="ms-3 results-count" id="resultsCount"></span>
        </div>

        <!-- Список лицензий -->
        <div class="licenses-list">
            <h5 class="mb-3">Список лицензий</h5>
            <div id="licensesList">
                <!-- Здесь будут карточки лицензий -->
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для детальной информации о лицензии -->
<div class="modal fade" id="licenseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Информация о лицензии</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Здесь будет отображаться детальная информация -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" onclick="showOnMap()">Показать на карте</button>
                {% if user.is_authenticated %}
                <button type="button" class="btn btn-primary" onclick="showUploadForm()">Загрузить документ</button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"
    type="text/javascript"></script>
<script>
    let currentLicenseId = null;
    let myMap;
    let allLicenses = [];
    let filteredLicenses = [];
    let placemarks = [];

    ymaps.ready(init);

    function init() {
        myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 5,
            controls: ['zoomControl', 'searchControl', 'typeSelector', 'fullscreenControl']
        });

        loadLicenses();
    }

    function loadLicenses() {
        fetch('/api/licenses/')
            .then(response => response.json())
            .then(data => {
                console.log(`Загружено лицензий: ${data.length}`);
                allLicenses = data;
                filteredLicenses = data;

                // Обновляем статистику
                updateStatistics();

                // Заполняем фильтры уникальными значениями
                populateFilters();

                // Отображаем лицензии
                displayLicenses();
                displayLicensesOnMap();
            })
            .catch(error => console.error('Ошибка загрузки лицензий:', error));
    }

    function updateStatistics() {
        // Общее количество лицензий
        document.getElementById('totalCount').textContent = allLicenses.length;
        
        // Количество активных лицензий
        const activeCount = allLicenses.filter(l => l.status === 'active').length;
        document.getElementById('activeCount').textContent = activeCount;
        
        // Количество уникальных регионов
        const uniqueRegions = [...new Set(allLicenses.map(l => l.region))];
        document.getElementById('regionCount').textContent = uniqueRegions.length;
        
        // Количество типов недропользования
        const uniqueTypes = [...new Set(allLicenses.map(l => l.license_type))];
        document.getElementById('typeCount').textContent = uniqueTypes.length;
    }

    function populateFilters() {
        const regions = [...new Set(allLicenses.map(l => l.region))].sort();
        const types = [...new Set(allLicenses.map(l => l.license_type))].sort();
        const minerals = [...new Set(allLicenses.map(l => l.mineral_type).filter(m => m))].sort();

        const regionSelect = document.getElementById('filterRegion');
        regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.textContent = region;
            regionSelect.appendChild(option);
        });

        const typeSelect = document.getElementById('filterType');
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
        });

        const mineralSelect = document.getElementById('filterMineral');
        minerals.forEach(mineral => {
            const option = document.createElement('option');
            option.value = mineral;
            option.textContent = mineral;
            mineralSelect.appendChild(option);
        });
    }

    function applyFilters() {
        const statusFilter = document.getElementById('filterStatus').value;
        const regionFilter = document.getElementById('filterRegion').value;
        const typeFilter = document.getElementById('filterType').value;
        const mineralFilter = document.getElementById('filterMineral').value;
        const searchText = document.getElementById('searchText').value.toLowerCase();

        filteredLicenses = allLicenses.filter(license => {
            if (statusFilter && license.status !== statusFilter) return false;
            if (regionFilter && license.region !== regionFilter) return false;
            if (typeFilter && license.license_type !== typeFilter) return false;
            if (mineralFilter && license.mineral_type !== mineralFilter) return false;
            if (searchText && !license.license_number.toLowerCase().includes(searchText) &&
                !license.owner.toLowerCase().includes(searchText)) return false;
            return true;
        });

        displayLicenses();
        displayLicensesOnMap();
        updateResultsCount();
    }

    function resetFilters() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterRegion').value = '';
        document.getElementById('filterType').value = '';
        document.getElementById('filterMineral').value = '';
        document.getElementById('searchText').value = '';
        applyFilters();
    }

    function updateResultsCount() {
        const count = filteredLicenses.length;
        const total = allLicenses.length;
        document.getElementById('resultsCount').textContent = `Найдено: ${count} из ${total}`;
    }

    function displayLicenses() {
        const container = document.getElementById('licensesList');

        if (filteredLicenses.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-5">Лицензии не найдены</p>';
            return;
        }

        container.innerHTML = filteredLicenses.map(license => `
        <div class="license-card" onclick="showLicenseDetails(${license.id})">
            <div class="d-flex justify-content-between align-items-start">
                <div class="license-card-title">${license.license_number}</div>
                <span class="status-badge status-${license.status}">${getStatusText(license.status)}</span>
            </div>
            <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">${license.owner}</p>
            
            <div class="license-meta">
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Регион</div>
                        <div class="meta-value">${license.region}</div>
                    </div>
                </div>
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Тип</div>
                        <div class="meta-value">${license.license_type}</div>
                    </div>
                </div>
                ${license.mineral_type ? `
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Полезное ископаемое</div>
                        <div class="meta-value">${license.mineral_type}</div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `).join('');

        updateResultsCount();
    }

    function displayLicensesOnMap() {
        // Удаляем старые метки
        myMap.geoObjects.removeAll();
        placemarks = [];

        filteredLicenses.forEach(license => {
            let geoObject;

            // Проверяем, есть ли полигон
            if (license.polygon_data && license.polygon_data.coordinates) {
                const geomType = license.polygon_data.type;

                // GeoJSON использует [longitude, latitude], а Яндекс [latitude, longitude]
                if (geomType === 'Polygon') {
                    // Простой полигон - конвертируем координаты
                    const convertedCoords = license.polygon_data.coordinates.map(ring =>
                        ring.map(coord => [coord[1], coord[0]])
                    );
                    geoObject = new ymaps.Polygon(
                        convertedCoords,
                        {
                            balloonContentHeader: `<strong>${license.license_number}</strong>`,
                            balloonContentBody: `
                        <div class="license-info">
                            <p><strong>Недропользователь:</strong> ${license.owner}</p>
                            <p><strong>Регион:</strong> ${license.region}</p>
                            <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                            <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                Подробнее
                            </button>
                        </div>
                    `,
                            hintContent: license.license_number
                        },
                        {
                            fillColor: getColorByUsageType(license.license_type),
                            fillOpacity: 0.3,
                            strokeColor: getColorByUsageType(license.license_type),
                            strokeWidth: 2,
                            strokeOpacity: 0.8
                        }
                    );
                } else if (geomType === 'MultiPolygon') {
                    // MultiPolygon - создаем коллекцию полигонов
                    const collection = new ymaps.GeoObjectCollection();
                    license.polygon_data.coordinates.forEach(polygonCoords => {
                        const convertedCoords = polygonCoords.map(ring =>
                            ring.map(coord => [coord[1], coord[0]])
                        );
                        const polygon = new ymaps.Polygon(
                            convertedCoords,
                            {
                                balloonContentHeader: `<strong>${license.license_number}</strong>`,
                                balloonContentBody: `
                                <div class="license-info">
                                    <p><strong>Недропользователь:</strong> ${license.owner}</p>
                                    <p><strong>Регион:</strong> ${license.region}</p>
                                    <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                                    <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                                    <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                        Подробнее
                                    </button>
                                </div>
                            `,
                                hintContent: license.license_number
                            },
                            {
                                fillColor: getColorByUsageType(license.license_type),
                                fillOpacity: 0.3,
                                strokeColor: getColorByUsageType(license.license_type),
                                strokeWidth: 2,
                                strokeOpacity: 0.8
                            }
                        );
                        collection.add(polygon);
                    });
                    geoObject = collection;
                }
            } else if (license.latitude && license.longitude) {
                // Создаём точку (для обратной совместимости)
                geoObject = new ymaps.Placemark(
                    [license.latitude, license.longitude],
                    {
                        balloonContentHeader: `<strong>${license.license_number}</strong>`,
                        balloonContentBody: `
                        <div class="license-info">
                            <p><strong>Недропользователь:</strong> ${license.owner}</p>
                            <p><strong>Регион:</strong> ${license.region}</p>
                            <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                            <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                Подробнее
                            </button>
                        </div>
                    `,
                        hintContent: license.license_number
                    },
                    {
                        preset: getPresetByUsageType(license.license_type)
                    }
                );
            }

            if (geoObject) {
                myMap.geoObjects.add(geoObject);
                placemarks.push(geoObject);
            }
        });

        console.log(`Отображено объектов на карте: ${placemarks.length}`);

        // Автоматически подстраиваем границы карты под объекты
        if (placemarks.length > 0) {
            try {
                const bounds = myMap.geoObjects.getBounds();
                console.log('Границы объектов:', bounds);
                myMap.setBounds(bounds, {
                    checkZoomRange: true,
                    zoomMargin: 100,
                    duration: 500
                });
            } catch (e) {
                console.error('Ошибка установки границ:', e);
            }
        } else {
            console.warn('Нет объектов для отображения на карте');
        }
    }

    function getColorByUsageType(usageType) {
        const colors = {
            'БЭ': '#3498db',
            'БП': '#27ae60',
            'БР': '#e67e22',
            'ТП': '#1abc9c',
            'ПВ': '#9b59b6',
            'ГС': '#f39c12',
            'КП': '#e74c3c',
            'РП': '#16a085',
            'СП': '#8e44ad',
            'УВС': '#2c3e50'
        };
        return colors[usageType] || '#95a5a6';
    }

    function getColorByStatus(status) {
        const colors = {
            'active': '#28a745',
            'expired': '#6c757d',
            'suspended': '#ffc107',
            'terminated': '#dc3545'
        };
        return colors[status] || '#007bff';
    }

    function getStatusText(status) {
        const statuses = {
            'active': 'Действующая',
            'expired': 'Истекла',
            'suspended': 'Приостановлена',
            'terminated': 'Прекращена'
        };
        return statuses[status] || status;
    }

    function getPresetByUsageType(usageType) {
        const presets = {
            'БЭ': 'islands#blueDotIcon',
            'БП': 'islands#greenDotIcon',
            'БР': 'islands#orangeDotIcon',
            'ТП': 'islands#lightBlueDotIcon',
            'ПВ': 'islands#violetDotIcon',
            'ГС': 'islands#yellowDotIcon',
            'КП': 'islands#redDotIcon',
            'РП': 'islands#darkGreenDotIcon',
            'СП': 'islands#darkBlueDotIcon',
            'УВС': 'islands#grayDotIcon'
        };
        return presets[usageType] || 'islands#grayDotIcon';
    }

    function getPresetByStatus(status) {
        const presets = {
            'active': 'islands#greenDotIcon',
            'expired': 'islands#grayDotIcon',
            'suspended': 'islands#yellowDotIcon',
            'terminated': 'islands#redDotIcon'
        };
        return presets[status] || 'islands#blueDotIcon';
    }

    let currentLicense = null;

    function showLicenseDetails(licenseId) {
        currentLicenseId = licenseId;
        fetch(`/api/licenses/${licenseId}/`)
            .then(response => response.json())
            .then(license => {
                currentLicense = license;
                document.getElementById('modalTitle').innerHTML = `Лицензия ${license.license_number}`;

                let documentsHtml = '';
                if (license.documents && license.documents.length > 0) {
                    documentsHtml = '<h6 class="mt-3">Документы:</h6><ul class="list-group">';
                    license.documents.forEach(doc => {
                        documentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${doc.title}
                            <a href="/api/documents/${doc.id}/download/" class="btn btn-sm btn-outline-primary">
                                Скачать
                            </a>
                        </li>
                    `;
                    });
                    documentsHtml += '</ul>';
                } else {
                    documentsHtml = '<p class="text-muted mt-3">Нет прикрепленных документов</p>';
                }

                document.getElementById('modalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Номер лицензии:</strong> ${license.license_number}</p>
                        <p><strong>Недропользователь:</strong> ${license.owner}</p>
                        <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                        <p><strong>Регион:</strong> ${license.region}</p>
                        <p><strong>Участок недр:</strong> ${license.area || 'Не указан'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Дата выдачи:</strong> ${license.issue_date}</p>
                        <p><strong>Дата окончания:</strong> ${license.expiry_date || 'Не указана'}</p>
                        <p><strong>Полезное ископаемое:</strong> ${license.mineral_type || 'Не указано'}</p>
                        <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                        <p><strong>Координаты:</strong> ${license.latitude}, ${license.longitude}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Описание:</strong></p>
                        <p>${license.description || 'Нет описания'}</p>
                    </div>
                </div>
                ${documentsHtml}
            `;

                const modal = new bootstrap.Modal(document.getElementById('licenseModal'));
                modal.show();
            })
            .catch(error => console.error('Ошибка загрузки деталей лицензии:', error));
    }

    function showUploadForm() {
        if (!currentLicenseId) {
            alert('Лицензия не выбрана');
            return;
        }

        const fileInput = document.createElement('input');

        fileInput.type = 'file';
        fileInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.jpg,.png';

        fileInput.onchange = () => {
            if (fileInput.files.length === 0) return;

            const selectedFile = fileInput.files[0];
            const defaultTitle = selectedFile.name;

            const title = prompt('Название документа:', defaultTitle);
            if (!title) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('title', title);
            formData.append('file_type', 'other');

            fetch(`/api/licenses/${currentLicenseId}/upload/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Документ успешно загружен');
                        showLicenseDetails(currentLicenseId);
                    } else {
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки документа:', error);
                    alert('Ошибка загрузки документа');
                });
        };

        fileInput.click();
    }

    function showOnMap() {
        if (!currentLicense) {
            alert('Лицензия не загружена');
            return;
        }

        // Закрываем модальное окно
        const modal = bootstrap.Modal.getInstance(document.getElementById('licenseModal'));
        modal.hide();

        // Прокручиваем к карте
        document.querySelector('.map-container').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        // Центрируем карту на точном местоположении лицензии с увеличенным зумом
        setTimeout(() => {
            myMap.setCenter([currentLicense.latitude, currentLicense.longitude], 15, {
                checkZoomRange: true,
                duration: 500
            });

            // Находим соответствующий маркер по ID лицензии и открываем его балун
            setTimeout(() => {
                const placemarkIndex = filteredLicenses.findIndex(license => license.id === currentLicense.id);

                if (placemarkIndex !== -1 && placemarks[placemarkIndex]) {
                    placemarks[placemarkIndex].balloon.open();
                }
            }, 600);
        }, 300);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}