{% extends 'licenses/base.html' %}

{% block title %}–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –ª–∏—Ü–µ–Ω–∑–∏–π{% endblock %}

{% block extra_css %}
<style>
    body {
        overflow-y: auto;
    }
    .main-container {
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 56px);
    }
    .content-area {
        flex: 1;
        padding: 20px;
        background-color: #f8f9fa;
    }
    .map-container {
        width: 100%;
        height: 400px;
        margin: 20px 0;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    #map {
        width: 100%;
        height: 100%;
    }
    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .licenses-list {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .license-card {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .license-card:hover {
        background-color: #f8f9fa;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    .status-active { background-color: #d4edda; color: #155724; }
    .status-expired { background-color: #d6d8db; color: #383d41; }
    .status-suspended { background-color: #fff3cd; color: #856404; }
    .status-terminated { background-color: #f8d7da; color: #721c24; }
    .filter-group {
        margin-bottom: 15px;
    }
    .filter-group label {
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- –ö–∞—Ä—Ç–∞ –≤–≤–µ—Ä—Ö—É –≤ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–º –æ–∫–æ—à–∫–µ -->
    <div class="map-container">
        <div id="map"></div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
    <div class="content-area">
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters-section">
            <h5 class="mb-3">üîç –§–∏–ª—å—Ç—Ä—ã –ª–∏—Ü–µ–Ω–∑–∏–π</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterStatus">–°—Ç–∞—Ç—É—Å:</label>
                        <select id="filterStatus" class="form-select" onchange="applyFilters()">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="active">–î–µ–π—Å—Ç–≤—É—é—â–∞—è</option>
                            <option value="expired">–ò—Å—Ç–µ–∫–ª–∞</option>
                            <option value="suspended">–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</option>
                            <option value="terminated">–ü—Ä–µ–∫—Ä–∞—â–µ–Ω–∞</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterRegion">–†–µ–≥–∏–æ–Ω:</label>
                        <select id="filterRegion" class="form-select" onchange="applyFilters()">
                            <option value="">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterType">–í–∏–¥ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</label>
                        <select id="filterType" class="form-select" onchange="applyFilters()">
                            <option value="">–í—Å–µ –≤–∏–¥—ã</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterMineral">–ü–æ–ª–µ–∑–Ω–æ–µ –∏—Å–∫–æ–ø–∞–µ–º–æ–µ:</label>
                        <select id="filterMineral" class="form-select" onchange="applyFilters()">
                            <option value="">–í—Å–µ –≤–∏–¥—ã</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="filter-group">
                        <label for="searchText">–ü–æ–∏—Å–∫:</label>
                        <input type="text" id="searchText" class="form-control" placeholder="–ù–æ–º–µ—Ä –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏–ª–∏ –Ω–µ–¥—Ä–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å..." onkeyup="applyFilters()">
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            <span class="ms-3 text-muted" id="resultsCount"></span>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –ª–∏—Ü–µ–Ω–∑–∏–π -->
        <div class="licenses-list">
            <h5 class="mb-3">üìã –°–ø–∏—Å–æ–∫ –ª–∏—Ü–µ–Ω–∑–∏–π</h5>
            <div id="licensesList">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–π -->
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏—Ü–µ–Ω–∑–∏–∏ -->
<div class="modal fade" id="licenseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏—Ü–µ–Ω–∑–∏–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            </div>
            <div class="modal-footer">
                {% if user.is_authenticated %}
                <button type="button" class="btn btn-primary" onclick="showUploadForm()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU" type="text/javascript"></script>
<script>
let currentLicenseId = null;
let myMap;
let allLicenses = [];
let filteredLicenses = [];
let placemarks = [];

ymaps.ready(init);

function init() {
    myMap = new ymaps.Map("map", {
        center: [55.76, 37.64],
        zoom: 5,
        controls: ['zoomControl', 'searchControl', 'typeSelector', 'fullscreenControl']
    });

    loadLicenses();
}

function loadLicenses() {
    fetch('/api/licenses/')
        .then(response => response.json())
        .then(data => {
            allLicenses = data;
            filteredLicenses = data;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            populateFilters();
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏–∏
            displayLicenses();
            displayLicensesOnMap();
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–π:', error));
}

function populateFilters() {
    const regions = [...new Set(allLicenses.map(l => l.region))].sort();
    const types = [...new Set(allLicenses.map(l => l.license_type))].sort();
    const minerals = [...new Set(allLicenses.map(l => l.mineral_type).filter(m => m))].sort();
    
    const regionSelect = document.getElementById('filterRegion');
    regions.forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region;
        regionSelect.appendChild(option);
    });
    
    const typeSelect = document.getElementById('filterType');
    types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
    });
    
    const mineralSelect = document.getElementById('filterMineral');
    minerals.forEach(mineral => {
        const option = document.createElement('option');
        option.value = mineral;
        option.textContent = mineral;
        mineralSelect.appendChild(option);
    });
}

function applyFilters() {
    const statusFilter = document.getElementById('filterStatus').value;
    const regionFilter = document.getElementById('filterRegion').value;
    const typeFilter = document.getElementById('filterType').value;
    const mineralFilter = document.getElementById('filterMineral').value;
    const searchText = document.getElementById('searchText').value.toLowerCase();
    
    filteredLicenses = allLicenses.filter(license => {
        if (statusFilter && license.status !== statusFilter) return false;
        if (regionFilter && license.region !== regionFilter) return false;
        if (typeFilter && license.license_type !== typeFilter) return false;
        if (mineralFilter && license.mineral_type !== mineralFilter) return false;
        if (searchText && !license.license_number.toLowerCase().includes(searchText) && 
            !license.owner.toLowerCase().includes(searchText)) return false;
        return true;
    });
    
    displayLicenses();
    displayLicensesOnMap();
    updateResultsCount();
}

function resetFilters() {
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterRegion').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterMineral').value = '';
    document.getElementById('searchText').value = '';
    applyFilters();
}

function updateResultsCount() {
    const count = filteredLicenses.length;
    const total = allLicenses.length;
    document.getElementById('resultsCount').textContent = `–ù–∞–π–¥–µ–Ω–æ: ${count} –∏–∑ ${total}`;
}

function displayLicenses() {
    const container = document.getElementById('licensesList');
    
    if (filteredLicenses.length === 0) {
        container.innerHTML = '<p class="text-muted">–õ–∏—Ü–µ–Ω–∑–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    container.innerHTML = filteredLicenses.map(license => `
        <div class="license-card" onclick="showLicenseDetails(${license.id})">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0">${license.license_number}</h6>
                <span class="status-badge status-${license.status}">${getStatusText(license.status)}</span>
            </div>
            <p class="mb-1"><strong>–ù–µ–¥—Ä–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${license.owner}</p>
            <p class="mb-1"><strong>–†–µ–≥–∏–æ–Ω:</strong> ${license.region}</p>
            <p class="mb-0 text-muted small">${license.license_type}</p>
        </div>
    `).join('');
    
    updateResultsCount();
}

function displayLicensesOnMap() {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∫–∏
    myMap.geoObjects.removeAll();
    placemarks = [];
    
    filteredLicenses.forEach(license => {
        const placemark = new ymaps.Placemark(
            [license.latitude, license.longitude],
            {
                balloonContentHeader: `<strong>${license.license_number}</strong>`,
                balloonContentBody: `
                    <div class="license-info">
                        <p><strong>–ù–µ–¥—Ä–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${license.owner}</p>
                        <p><strong>–†–µ–≥–∏–æ–Ω:</strong> ${license.region}</p>
                        <p><strong>–í–∏–¥ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</strong> ${license.license_type}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getStatusText(license.status)}</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                    </div>
                `,
                hintContent: license.license_number
            },
            {
                preset: getPresetByStatus(license.status)
            }
        );
        myMap.geoObjects.add(placemark);
        placemarks.push(placemark);
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã –ø–æ–¥ –º–∞—Ä–∫–µ—Ä—ã
    if (placemarks.length > 0) {
        myMap.setBounds(myMap.geoObjects.getBounds(), {
            checkZoomRange: true,
            zoomMargin: 50
        });
    }
}

function getStatusText(status) {
    const statuses = {
        'active': '–î–µ–π—Å—Ç–≤—É—é—â–∞—è',
        'expired': '–ò—Å—Ç–µ–∫–ª–∞',
        'suspended': '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞',
        'terminated': '–ü—Ä–µ–∫—Ä–∞—â–µ–Ω–∞'
    };
    return statuses[status] || status;
}

function getPresetByStatus(status) {
    const presets = {
        'active': 'islands#greenDotIcon',
        'expired': 'islands#grayDotIcon',
        'suspended': 'islands#yellowDotIcon',
        'terminated': 'islands#redDotIcon'
    };
    return presets[status] || 'islands#blueDotIcon';
}

function showLicenseDetails(licenseId) {
    currentLicenseId = licenseId;
    fetch(`/api/licenses/${licenseId}/`)
        .then(response => response.json())
        .then(license => {
            document.getElementById('modalTitle').innerHTML = `–õ–∏—Ü–µ–Ω–∑–∏—è ${license.license_number}`;
            
            let documentsHtml = '';
            if (license.documents && license.documents.length > 0) {
                documentsHtml = '<h6 class="mt-3">–î–æ–∫—É–º–µ–Ω—Ç—ã:</h6><ul class="list-group">';
                license.documents.forEach(doc => {
                    documentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${doc.title}
                            <a href="/api/documents/${doc.id}/download/" class="btn btn-sm btn-outline-primary">
                                –°–∫–∞—á–∞—Ç—å
                            </a>
                        </li>
                    `;
                });
                documentsHtml += '</ul>';
            } else {
                documentsHtml = '<p class="text-muted mt-3">–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>';
            }
            
            document.getElementById('modalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>–ù–æ–º–µ—Ä –ª–∏—Ü–µ–Ω–∑–∏–∏:</strong> ${license.license_number}</p>
                        <p><strong>–ù–µ–¥—Ä–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${license.owner}</p>
                        <p><strong>–í–∏–¥ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</strong> ${license.license_type}</p>
                        <p><strong>–†–µ–≥–∏–æ–Ω:</strong> ${license.region}</p>
                        <p><strong>–£—á–∞—Å—Ç–æ–∫ –Ω–µ–¥—Ä:</strong> ${license.area || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏:</strong> ${license.issue_date}</p>
                        <p><strong>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong> ${license.expiry_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–ü–æ–ª–µ–∑–Ω–æ–µ –∏—Å–∫–æ–ø–∞–µ–º–æ–µ:</strong> ${license.mineral_type || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getStatusText(license.status)}</p>
                        <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${license.latitude}, ${license.longitude}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong></p>
                        <p>${license.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                    </div>
                </div>
                ${documentsHtml}
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('licenseModal'));
            modal.show();
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ª–∏—Ü–µ–Ω–∑–∏–∏:', error));
}

function showUploadForm() {
    if (!currentLicenseId) {
        alert('–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞');
        return;
    }
    
    const title = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞:');
    if (!title) return;
    
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.jpg,.png';
    
    fileInput.onchange = () => {
        if (fileInput.files.length === 0) return;
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('title', title);
        formData.append('file_type', 'other');
        
        fetch(`/api/licenses/${currentLicenseId}/upload/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω');
                showLicenseDetails(currentLicenseId);
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞');
        });
    };
    
    fileInput.click();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
