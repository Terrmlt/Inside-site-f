{% extends 'licenses/base.html' %}

{% block title %}Интерактивная карта лицензий{% endblock %}

{% block extra_css %}
<style>
    body {
        overflow-y: auto;
        background-color: var(--bg-light);
    }

    .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0;
    }

    /* Quick Navigation Menu */
    .quick-nav {
        position: sticky;
        top: 0;
        background: var(--bg-light);
        border-bottom: 1px solid var(--border-color);
        z-index: 1100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        padding: 0 2rem;
    }

    .quick-nav-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0.75rem 0;
        gap: 1rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .quick-nav-link {
        padding: 0.625rem 1.5rem;
        color: var(--text-muted);
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9375rem;
        transition: all 0.2s;
        display: inline-block;
    }

    .quick-nav-link:hover {
        background: var(--bg-section);
        color: var(--text-dark);
        transform: translateY(-1px);
    }

    .quick-nav-link.external {
        background: var(--accent-color);
        color: white;
    }

    .quick-nav-link.external:hover {
        background: var(--accent-hover);
        color: white;
    }

    /* Back to Top Button */
    .back-to-top {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: var(--accent-color);
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        transition: all 0.3s;
        z-index: 1000;
        border: none;
    }

    .back-to-top:hover {
        background: var(--accent-hover);
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .back-to-top.show {
        display: flex;
    }

    .hero-section {
        background: linear-gradient(135deg, var(--hero-gradient-start) 0%, var(--hero-gradient-end) 100%);
        color: var(--text-dark);
        padding: 2.5rem 2rem 2rem;
        position: relative;
        border-radius: 0 0 32px 32px;
        text-align: center;
    }

    .hero-title {
        font-size: 2.5rem;
        font-weight: 700;
        letter-spacing: -0.04em;
        margin-bottom: 1.5rem;
        line-height: 1.1;
        text-align: center;
    }

    .hero-subtitle {
        font-size: 1.125rem;
        color: var(--text-muted);
        margin-bottom: 1.5rem;
        font-weight: 400;
        text-align: center;
    }

    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .stat-card {
        text-align: center;
        padding: 1.5rem;
        background: var(--bg-light);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        transition: all 0.3s;
        box-shadow: var(--shadow-sm);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 1rem;
        opacity: 0.9;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--accent-color);
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 600;
    }

    .content-area {
        padding: 3rem 2rem;
    }

    .section-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .section-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1rem;
        letter-spacing: -0.03em;
    }

    .section-subtitle {
        font-size: 1.125rem;
        color: var(--text-muted);
        max-width: 600px;
        margin: 0 auto;
    }

    .tabs-section {
        margin-bottom: 2.5rem;
        text-align: center;
    }

    .tabs-section-title {
        font-size: 0.9375rem;
        font-weight: 400;
        color: var(--text-muted);
        opacity: 0.75;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .license-tabs {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .tab-button {
        padding: 1rem 2rem;
        background: var(--bg-light);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-dark);
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tab-button:hover {
        border-color: var(--accent-color);
        background: var(--bg-section);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(96, 165, 250, 0.2);
    }

    .tab-button.active {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
        box-shadow: 0 4px 16px rgba(96, 165, 250, 0.3);
    }

    .tab-button.active:hover {
        background: #3B82F6;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(96, 165, 250, 0.4);
    }

    .tab-color-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tab-button:hover .tab-color-indicator {
        transform: scale(1.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .tab-button.active .tab-color-indicator {
        background: white !important;
        box-shadow: 0 2px 6px rgba(255, 255, 255, 0.3);
    }

    .tab-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 24px;
        height: 24px;
        padding: 0 8px;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 700;
    }

    .tab-button .tab-count {
        background: var(--bg-section);
        color: var(--text-dark);
    }

    .tab-button.active .tab-count {
        background: rgba(255, 255, 255, 0.25);
        color: white;
    }

    .map-container {
        position: relative;
        width: 100%;
        height: 600px;
        margin-bottom: 3rem;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--shadow-xl);
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        cursor: pointer;
        transition: opacity 0.3s ease;
    }

    .map-overlay-message {
        background: var(--bg-light);
        padding: 1.5rem 2.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-dark);
        pointer-events: none;
        border: 1px solid var(--border-color);
    }

    [data-theme="dark"] .map-overlay-message {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    }

    .map-overlay-icon {
        width: 32px;
        height: 32px;
        color: var(--accent-color);
    }

    /* Контейнер для фильтров и лицензий */
    .filters-licenses-container {
        display: flex;
        gap: 2rem;
        margin-bottom: 3rem;
        align-items: flex-start;
    }

    /* Боковая панель с фильтрами */
    .filters-sidebar {
        width: 350px;
        min-width: 320px;
        background: var(--bg-section);
        padding: 1.5rem;
        border-radius: 16px;
        position: sticky;
        top: 100px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        overflow-x: hidden;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }

    /* Кастомный скроллбар для боковой панели */
    .filters-sidebar::-webkit-scrollbar {
        width: 8px;
    }

    .filters-sidebar::-webkit-scrollbar-track {
        background: var(--bg-light);
        border-radius: 4px;
    }

    .filters-sidebar::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
    }

    .filters-sidebar::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
    }

    .filters-sidebar h5 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1.5rem;
        letter-spacing: -0.02em;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    /* Основная область с лицензиями */
    .licenses-content {
        flex: 1;
        background: var(--bg-section);
        padding: 2.5rem;
        border-radius: 16px;
        min-width: 0;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
    }

    .licenses-content h5 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 2rem;
        letter-spacing: -0.03em;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    /* Старые классы для обратной совместимости */
    .filters-section {
        background: var(--bg-section);
        padding: 2.5rem;
        border-radius: 16px;
        margin-bottom: 3rem;
    }

    .filters-section h5 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 2rem;
        letter-spacing: -0.03em;
    }

    .licenses-list {
        background: var(--bg-section);
        padding: 2.5rem;
        border-radius: 16px;
        margin-bottom: 3rem;
    }

    .licenses-list h5 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 2rem;
        letter-spacing: -0.03em;
    }

    /* Адаптивность для мобильных устройств */
    @media (max-width: 992px) {
        .filters-licenses-container {
            flex-direction: column;
            gap: 1.5rem;
        }

        .filters-sidebar {
            width: 100%;
            min-width: unset;
            position: static;
            max-height: none;
            top: auto;
        }

        .licenses-content {
            width: 100%;
        }
    }

    /* Дополнительная адаптивность для очень маленьких экранов */
    @media (max-width: 576px) {
        .filters-sidebar {
            padding: 1rem;
        }

        .licenses-content {
            padding: 1.5rem;
        }

        .filters-sidebar h5,
        .licenses-content h5 {
            font-size: 1.125rem;
        }
    }

    .pagination-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 3rem;
        padding: 2rem 0;
    }

    .pagination-info {
        font-size: 0.95rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .pagination-btn {
        padding: 0.75rem 1.25rem;
        background: var(--bg-light);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-dark);
        cursor: pointer;
        transition: all 0.3s;
        min-width: 45px;
        text-align: center;
    }

    .pagination-btn:hover:not(:disabled) {
        border-color: var(--accent-color);
        background: var(--bg-section);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .pagination-btn.active {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .pagination-ellipsis {
        padding: 0.75rem;
        color: var(--text-muted);
        font-weight: 600;
    }

    .license-card {
        background: var(--bg-light);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .license-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--accent-color);
    }

    .license-card-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        letter-spacing: -0.02em;
    }

    .license-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .meta-icon {
        width: 32px;
        height: 32px;
        padding: 6px;
        background: var(--bg-section);
        border-radius: 8px;
        flex-shrink: 0;
    }

    .meta-content {
        flex: 1;
    }

    .meta-label {
        font-size: 0.75rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .meta-value {
        font-size: 1rem;
        color: var(--text-dark);
        font-weight: 600;
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-active {
        background-color: #dcfce7;
        color: var(--success-color);
    }

    .status-expired {
        background-color: #d4d4d4;
        color: #666666;
    }

    .status-suspended {
        background-color: #e8d9a8;
        color: var(--warning-color);
    }

    .status-terminated {
        background-color: #e8d4d4;
        color: var(--danger-color);
    }

    [data-theme="dark"] .status-active {
        background-color: #1e3a2e;
        color: #34d399;
    }

    [data-theme="dark"] .status-expired {
        background-color: #2d2d2d;
        color: #94a3b8;
    }

    [data-theme="dark"] .status-suspended {
        background-color: #3d3420;
        color: #fbbf24;
    }

    [data-theme="dark"] .status-terminated {
        background-color: #3d2a2a;
        color: #f87171;
    }

    .filter-group {
        margin-bottom: 1.5rem;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: block;
        color: var(--text-dark);
        font-size: 0.9375rem;
    }

    .form-select,
    .form-control {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.2s;
        font-size: 1rem;
        background: var(--bg-light);
        color: var(--text-dark);
    }

    .form-control::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
    }

    .form-control::-webkit-input-placeholder {
        color: var(--text-muted);
        opacity: 0.7;
    }

    .form-control::-moz-placeholder {
        color: var(--text-muted);
        opacity: 0.7;
    }

    .form-control:-ms-input-placeholder {
        color: var(--text-muted);
        opacity: 0.7;
    }

    [data-theme="dark"] .form-control::placeholder {
        color: var(--text-muted);
        opacity: 1;
    }

    [data-theme="dark"] .form-control::-webkit-input-placeholder {
        color: var(--text-muted);
        opacity: 1;
    }

    [data-theme="dark"] .form-control::-moz-placeholder {
        color: var(--text-muted);
        opacity: 1;
    }

    [data-theme="dark"] .form-control:-ms-input-placeholder {
        color: var(--text-muted);
        opacity: 1;
    }

    /* Стили для фильтров в боковой панели */
    .filters-sidebar .filter-group {
        margin-bottom: 1.25rem;
    }

    .filters-sidebar .filter-group label {
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .filters-sidebar .form-select,
    .filters-sidebar .form-control {
        font-size: 0.9375rem;
        padding: 0.625rem 0.875rem;
    }

    .filters-sidebar .row {
        margin-left: 0;
        margin-right: 0;
    }

    .filters-sidebar .col-md-6,
    .filters-sidebar .col-12 {
        padding-left: 0;
        padding-right: 0;
        width: 100%;
    }

    /* Кнопки в боковой панели */
    .filters-sidebar .btn {
        font-size: 0.875rem;
        padding: 0.625rem 1rem;
    }

    .filters-sidebar .btn-sm {
        font-size: 0.8125rem;
        padding: 0.5rem 0.875rem;
    }

    /* Экспорт кнопки в боковой панели */
    .filters-sidebar .export-btn {
        width: 100%;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    }

    .filters-sidebar .export-text {
        font-size: 0.875rem;
    }

    .filters-sidebar .export-btn svg {
        flex-shrink: 0;
    }

    /* Результаты в боковой панели */
    .filters-sidebar .results-count {
        font-size: 0.875rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        display: block;
    }

    .filters-sidebar .d-flex {
        flex-direction: column;
        gap: 0.75rem;
    }

    .filters-sidebar .gap-2 {
        gap: 0.5rem !important;
    }

    .form-select:focus,
    .form-control:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    .btn {
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.2s;
        border: none;
        font-size: 1rem;
    }

    .btn-secondary {
        background-color: var(--bg-section);
        color: var(--text-dark);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background-color: var(--border-color);
        transform: translateY(-2px);
    }

    .btn-info {
        background-color: var(--info-color);
        color: white;
    }

    .btn-info:hover {
        background-color: #60A5FA;
        transform: translateY(-2px);
    }

    .btn-primary {
        background-color: var(--accent-color);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--accent-hover);
        transform: translateY(-2px);
    }

    .legend {
        background: var(--bg-light);
        padding: 0;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        font-size: 0.9375rem;
        margin-bottom: 3rem;
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .legend-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 2rem;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
        position: relative;
    }

    .legend-header:hover {
        background: var(--bg-section);
    }

    .legend-header:focus {
        outline: 2px solid var(--accent-color);
        outline-offset: -2px;
        border-radius: 12px;
    }

    .legend-title {
        font-weight: 700;
        margin: 0;
        font-size: 1.125rem;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .legend-toggle-icon {
        width: 20px;
        height: 20px;
        transition: transform 0.3s ease;
        flex-shrink: 0;
    }

    .legend.collapsed .legend-toggle-icon {
        transform: rotate(-90deg);
    }

    .legend:not(.collapsed) .legend-toggle-icon {
        transform: rotate(0deg);
    }

    .legend-content {
        padding: 0 2rem 1.5rem 2rem;
        max-height: 500px;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
        opacity: 1;
    }

    .legend.collapsed .legend-content {
        max-height: 0;
        padding: 0 2rem;
        opacity: 0;
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 2rem;
        margin-bottom: 0.75rem;
        font-weight: 500;
        color: var(--text-dark);
    }

    .legend-color {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        margin-right: 0.75rem;
        border: 2px solid rgba(0, 0, 0, 0.1);
    }

    .results-count {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 1rem;
    }

    .modal {
        z-index: 1200;
    }

    .modal-backdrop {
        z-index: 1199;
    }

    .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: var(--shadow-xl);
        background: var(--bg-light);
    }

    .modal-header {
        background: linear-gradient(135deg, var(--text-dark) 0%, var(--primary-light) 100%);
        color: white;
        border-radius: 16px 16px 0 0;
        border-bottom: none;
        padding: 2rem;
    }

    [data-theme="dark"] .modal-header {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: white;
    }

    .modal-title {
        font-weight: 700;
        font-size: 1.5rem;
        letter-spacing: -0.02em;
    }

    .modal-body {
        padding: 2.5rem;
        background: var(--bg-light);
        color: var(--text-dark);
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
        padding: 1.5rem 2rem;
        background: var(--bg-section);
        border-radius: 0 0 16px 16px;
    }

    .btn-close {
        filter: brightness(0) invert(1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Quick Navigation -->
<div class="quick-nav">
    <div class="quick-nav-container">
        <a href="#licenses" class="quick-nav-link">Лицензии</a>
        <a href="#map-section" class="quick-nav-link">Карта</a>
        <a href="/analytics/" class="quick-nav-link">Аналитика</a>
        <a href="/help/" class="quick-nav-link external">Помощь</a>
    </div>
</div>

<!-- Back to Top Button -->
<button class="back-to-top" id="backToTop">
    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
        <path fill-rule="evenodd"
            d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z" />
    </svg>
</button>

<div class="main-container">
    <!-- Hero Section -->
    <div class="hero-section" id="hero">
        <div class="container">
            <h1 class="hero-title">База лицензий на недропользование</h1>
            <p class="hero-subtitle">Интерактивная система управления и визуализации лицензий на право пользования
                недрами</p>

            <!-- Statistics Cards (динамически генерируются) -->
            <div class="stats-container" id="statistics"></div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Map Section -->
        <!-- <div class="section-header" style="margin-top: 4rem;" id="map-section">
            <h2 class="section-title">Интерактивная карта</h2>
            <p class="section-subtitle">Визуализация месторасположения лицензионных участков на интерактивной карте</p>
        </div> -->

        <!-- License Type Tabs (динамически генерируются) -->
        <div class="tabs-section">
            <h3 class="tabs-section-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem; vertical-align: middle;">
                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"/>
                </svg>
                Быстрый фильтр по типу недропользования:
            </h3>
            <div class="license-tabs" id="licenseTypeTabs"></div>
        </div>

        <div class="map-container" id="map-section">
            <div id="map"></div>
            <div class="map-overlay" id="mapOverlay" role="button" tabindex="0" aria-label="Активировать карту">
                <div class="map-overlay-message">
                    <svg class="map-overlay-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
                    </svg>
                    Нажмите для активации карты
                </div>
            </div>
        </div>

        <!-- Legend (динамически генерируется) -->
        <div class="legend collapsed" id="mapLegend">
            <div class="legend-header" onclick="toggleLegend()" role="button" tabindex="0" aria-expanded="false" aria-controls="legendContent" title="Нажмите, чтобы развернуть легенду">
                <div class="legend-title">
                    <svg class="legend-toggle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                    <span>Цвета полигонов по виду пользования недрами</span>
                </div>
            </div>
            <div class="legend-content" id="legendContent">
                <div class="d-flex flex-wrap" id="legendItems"></div>
            </div>
        </div>

        <!-- Контейнер для фильтров и лицензий -->
        <div class="filters-licenses-container" id="licenses">
            <!-- Боковая панель с фильтрами -->
            <div class="filters-sidebar">
                <h5>Фильтры и поиск</h5>
                <div class="filter-group">
                    <label for="filterStatus">Статус:</label>
                    <select id="filterStatus" class="form-select" onchange="applyFilters()">
                        <option value="">Все статусы</option>
                        <option value="active">Действующая</option>
                        <option value="expired">Истекла</option>
                        <option value="suspended">Приостановлена</option>
                        <option value="terminated">Прекращена</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterRegion">Регион:</label>
                    <select id="filterRegion" class="form-select" onchange="applyFilters()">
                        <option value="">Все регионы</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterType">Вид пользования:</label>
                    <select id="filterType" class="form-select" onchange="applyFilters()">
                        <option value="">Все виды</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterMineral">Полезное ископаемое:</label>
                    <select id="filterMineral" class="form-select" onchange="applyFilters()">
                        <option value="">Все виды</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchText">Поиск:</label>
                    <input type="text" id="searchText" class="form-control"
                        placeholder="Номер лицензии или недропользователь..." onkeyup="applyFilters()">
                </div>
                <div class="d-flex flex-column gap-2">
                    <button class="btn btn-secondary btn-sm" onclick="resetFilters()">Сбросить фильтры</button>
                    <button class="btn btn-primary export-btn" onclick="exportToExcel()" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Экспортировать данные в формат Excel для анализа и обработки">
                        <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                            <path
                                d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z" />
                            <path
                                d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z" />
                        </svg>
                        <span class="export-text">Экспорт в Excel</span>
                    </button>
                    <button class="btn btn-primary export-btn" onclick="exportToPDF()" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Экспортировать данные в формат PDF для печати и отчетности">
                        <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                            <path
                                d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5L14 4.5z" />
                            <path
                                d="M1.6 11.85H0v3.999h.791v-1.342h.803c.287 0 .531-.057.732-.173.203-.117.358-.275.463-.474a1.42 1.42 0 0 0 .161-.677c0-.25-.053-.476-.158-.677a1.176 1.176 0 0 0-.46-.477c-.2-.12-.443-.179-.732-.179Zm.545 1.333a.795.795 0 0 1-.085.38.574.574 0 0 1-.238.241.794.794 0 0 1-.375.082H.788V12.48h.66c.218 0 .389.06.512.181.123.122.185.296.185.522Zm1.217-1.333v3.999h1.46c.401 0 .734-.08.998-.237a1.45 1.45 0 0 0 .595-.689c.13-.3.196-.662.196-1.084 0-.42-.065-.778-.196-1.075a1.426 1.426 0 0 0-.589-.68c-.264-.156-.599-.234-1.005-.234H3.362Zm.791.645h.563c.248 0 .45.05.609.152a.89.89 0 0 1 .354.454c.079.201.118.452.118.753a2.3 2.3 0 0 1-.068.592 1.14 1.14 0 0 1-.196.422.8.8 0 0 1-.334.252 1.298 1.298 0 0 1-.483.082h-.563v-2.707Zm3.743 1.763v1.591h-.79V11.85h2.548v.653H7.896v1.117h1.606v.638H7.896Z" />
                        </svg>
                        <span class="export-text">Экспорт в PDF</span>
                    </button>
                    <!-- Индикатор загрузки -->
                    <div class="spinner-border text-primary export-spinner" role="status" style="display: none;">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <span class="results-count" id="resultsCount"></span>
                </div>
            </div>

            <!-- Основная область со списком лицензий -->
            <div class="licenses-content">
                <h5 class="mb-3" id="licensesListHeader">Список лицензий</h5>
                <div id="licensesList">
                    <!-- Здесь будут карточки лицензий -->
                </div>

                <!-- Пагинация -->
                <div class="pagination-container" id="paginationContainer" style="display: none;">
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="prevBtn" onclick="changePage('prev')">
                            ← Назад
                        </button>
                        <div id="pageNumbers" class="pagination-controls">
                            <!-- Номера страниц будут добавлены динамически -->
                        </div>
                        <button class="pagination-btn" id="nextBtn" onclick="changePage('next')">
                            Вперёд →
                        </button>
                    </div>
                    <div class="pagination-info" id="paginationInfo">
                        <!-- Информация о странице -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для детальной информации о лицензии -->
<div class="modal fade" id="licenseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Информация о лицензии</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Здесь будет отображаться детальная информация -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" onclick="showOnMap()">Показать на карте</button>
                {% if user.is_authenticated %}
                <button type="button" class="btn btn-primary" onclick="showUploadForm()">Загрузить документ</button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"
    type="text/javascript"></script>
<script>
    let currentLicenseId = null;
    let myMap;
    let allLicenses = [];
    let filteredLicenses = [];
    let placemarks = [];
    let currentPage = 1;
    let paginationData = null;
    let currentFiltersActive = false;
    const ITEMS_PER_PAGE = 12;

    ymaps.ready(init);

    let isMapActivated = false;

    function init() {
        myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 5,
            controls: ['zoomControl', 'searchControl', 'typeSelector', 'fullscreenControl']
        });

        // Отключаем скролл-зум по умолчанию
        myMap.behaviors.disable('scrollZoom');

        // Добавляем обработчик активации карты по клику на оверлей
        const mapOverlay = document.getElementById('mapOverlay');
        if (mapOverlay) {
            mapOverlay.addEventListener('click', activateMap);
            // Поддержка клавиатуры (Enter и Space)
            mapOverlay.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    activateMap();
                }
            });
        }

        loadLicenses();
    }

    function activateMap() {
        if (isMapActivated) return;
        
        isMapActivated = true;
        
        // Включаем скролл-зум
        myMap.behaviors.enable('scrollZoom');
        
        // Убираем оверлей с плавной анимацией
        const mapOverlay = document.getElementById('mapOverlay');
        if (mapOverlay) {
            mapOverlay.style.opacity = '0';
            setTimeout(() => {
                mapOverlay.remove();
            }, 300);
        }
    }

    function loadLicenses(page = 1) {
        currentPage = page;
        fetch(`/api/licenses/?page=${page}&page_size=12`)
            .then(response => response.json())
            .then(data => {
                console.log(`Загружено лицензий: ${data.results.length}`);

                // Сохраняем данные пагинации
                paginationData = data.pagination;

                // Если это первая загрузка, загружаем все лицензии для статистики и фильтров
                if (page === 1) {
                    loadAllLicensesForStats();
                }

                // Отображаем лицензии текущей страницы
                filteredLicenses = data.results;
                displayLicenses();
                displayLicensesOnMap();

                // Отображаем пагинацию
                displayPagination();

                // Обновляем счетчик результатов
                updateResultsCount();
            })
            .catch(error => console.error('Ошибка загрузки лицензий:', error));
    }

    function loadAllLicensesForStats() {
        // Загружаем ВСЕ лицензии для статистики без пагинации
        fetch('/api/licenses/all/')
            .then(response => response.json())
            .then(data => {
                allLicenses = data;

                try {
                    // Обновляем статистику
                    updateStatistics();

                    // Генерируем динамические элементы
                    generateLicenseTypeTabs();
                    generateMapLegend();

                    // Обновляем счетчики ПОСЛЕ создания кнопок
                    updateTabCounts();

                    // Заполняем фильтры уникальными значениями
                    populateFilters();

                    // Обновляем карту, если фильтры не применены
                    if (!currentFiltersActive) {
                        displayLicensesOnMap();
                    }
                } catch (error) {
                    console.error('Ошибка в обработке данных:', error);
                    console.error('Stack trace:', error.stack);
                }
            })
            .catch(error => console.error('Ошибка загрузки статистики:', error));
    }

    function displayPagination() {
        const container = document.getElementById('paginationContainer');
        const pageNumbersDiv = document.getElementById('pageNumbers');
        const paginationInfo = document.getElementById('paginationInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        if (!paginationData || paginationData.total_pages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'flex';

        // Обновляем кнопки Назад/Вперёд
        prevBtn.disabled = !paginationData.has_previous;
        nextBtn.disabled = !paginationData.has_next;

        // Информация о странице
        const start = (paginationData.current_page - 1) * 12 + 1;
        const end = Math.min(paginationData.current_page * 12, paginationData.total_count);
        paginationInfo.innerHTML = `Показано ${start}–${end} из ${paginationData.total_count}`;

        // Генерируем номера страниц
        pageNumbersDiv.innerHTML = '';
        const totalPages = paginationData.total_pages;
        const current = paginationData.current_page;

        // Логика отображения страниц
        let pages = [];

        if (totalPages <= 7) {
            // Показываем все страницы
            for (let i = 1; i <= totalPages; i++) {
                pages.push(i);
            }
        } else {
            // Показываем первую, последнюю и соседние
            pages.push(1);

            if (current > 3) {
                pages.push('...');
            }

            for (let i = Math.max(2, current - 1); i <= Math.min(totalPages - 1, current + 1); i++) {
                pages.push(i);
            }

            if (current < totalPages - 2) {
                pages.push('...');
            }

            pages.push(totalPages);
        }

        // Создаём кнопки
        pages.forEach(page => {
            if (page === '...') {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                pageNumbersDiv.appendChild(ellipsis);
            } else {
                const btn = document.createElement('button');
                btn.className = 'pagination-btn' + (page === current ? ' active' : '');
                btn.textContent = page;
                btn.onclick = () => changePage(page);
                pageNumbersDiv.appendChild(btn);
            }
        });
    }

    function changePage(direction) {
        if (currentFiltersActive) {
            // Клиентская пагинация (с фильтрами)
            let newPage;

            const totalPages = Math.ceil(filteredLicenses.length / ITEMS_PER_PAGE);

            if (direction === 'prev') {
                newPage = Math.max(1, currentPage - 1);
            } else if (direction === 'next') {
                newPage = Math.min(totalPages, currentPage + 1);
            } else {
                newPage = direction; // Номер страницы
            }

            displayFilteredPage(newPage);
        } else {
            // Серверная пагинация (без фильтров)
            let newPage;

            if (direction === 'prev') {
                newPage = paginationData.previous_page;
            } else if (direction === 'next') {
                newPage = paginationData.next_page;
            } else {
                newPage = direction; // Номер страницы
            }

            if (newPage) {
                loadLicenses(newPage);
            }
        }

        // Прокрутка к заголовку списка лицензий с задержкой для обновления контента
        setTimeout(() => {
            const header = document.getElementById('licensesListHeader');
            if (header) {
                header.scrollIntoView({behavior: 'smooth', block: 'start'});
            } else {
                // Fallback на контейнер, если заголовок не найден
                const container = document.querySelector('.licenses-content');
                if (container) {
                    container.scrollIntoView({behavior: 'smooth', block: 'start'});
                }
            }
        }, 100);
    }

    function updatePagination(totalItems, currentPageNum, isFiltered) {
        const container = document.querySelector('.pagination-container');
        const pageNumbersDiv = document.getElementById('pageNumbers');
        const paginationInfo = document.getElementById('paginationInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

        // Скрываем пагинацию если результатов мало
        if (totalItems <= ITEMS_PER_PAGE) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'flex';

        // Обновляем кнопки Назад/Вперёд
        prevBtn.disabled = currentPageNum <= 1;
        nextBtn.disabled = currentPageNum >= totalPages;

        // Информация о странице
        const start = (currentPageNum - 1) * ITEMS_PER_PAGE + 1;
        const end = Math.min(currentPageNum * ITEMS_PER_PAGE, totalItems);
        paginationInfo.innerHTML = `Показано ${start}–${end} из ${totalItems}`;

        // Генерируем номера страниц
        pageNumbersDiv.innerHTML = '';
        const current = currentPageNum;

        // Определяем диапазон страниц для отображения
        let startPage = Math.max(1, current - 2);
        let endPage = Math.min(totalPages, current + 2);

        // Корректируем диапазон, если мы близко к началу или концу
        if (current <= 3) {
            endPage = Math.min(5, totalPages);
        }
        if (current >= totalPages - 2) {
            startPage = Math.max(1, totalPages - 4);
        }

        // Первая страница
        if (startPage > 1) {
            const btn = document.createElement('button');
            btn.className = 'pagination-btn';
            btn.textContent = '1';
            btn.onclick = () => changePage(1);
            pageNumbersDiv.appendChild(btn);

            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                pageNumbersDiv.appendChild(ellipsis);
            }
        }

        // Страницы в диапазоне
        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.className = `pagination-btn ${i === current ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => changePage(i);
            pageNumbersDiv.appendChild(btn);
        }

        // Последняя страница
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                pageNumbersDiv.appendChild(ellipsis);
            }

            const btn = document.createElement('button');
            btn.className = 'pagination-btn';
            btn.textContent = totalPages;
            btn.onclick = () => changePage(totalPages);
            pageNumbersDiv.appendChild(btn);
        }
    }

    function updateStatistics() {
        const container = document.getElementById('statistics');
        if (!container) return;

        // Получаем статистику
        const totalCount = allLicenses.length;
        const activeCount = allLicenses.filter(l => l.status === 'active').length;
        const uniqueRegions = [...new Set(allLicenses.map(l => l.region))];
        const uniqueTypes = [...new Set(allLicenses.map(l => l.license_type))];

        // 4 фиксированные статистические карточки
        container.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${totalCount}</div>
                <div class="stat-label">Всего лицензий</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${activeCount}</div>
                <div class="stat-label">Действующие</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${uniqueRegions.length}</div>
                <div class="stat-label">Регионов</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${uniqueTypes.length}</div>
                <div class="stat-label">Типов недропользования</div>
            </div>
        `;
    }

    function updateTabCounts() {
        // Обновляем счетчик "Все"
        const countAllElement = document.getElementById('countAll');
        if (countAllElement) {
            countAllElement.textContent = allLicenses.length;
        }

        // Обновляем счетчики для каждого типа
        const uniqueTypes = [...new Set(allLicenses.map(l => l.license_type))].sort();
        uniqueTypes.forEach(type => {
            const count = allLicenses.filter(l => l.license_type === type).length;
            const countElement = document.getElementById(`count-${type}`);
            if (countElement) {
                countElement.textContent = count;
            }
        });
    }

    function generateLicenseTypeTabs() {
        const container = document.getElementById('licenseTypeTabs');
        if (!container) return;

        // Получаем уникальные типы лицензий
        const uniqueTypes = [...new Set(allLicenses.map(l => l.license_type))].sort();

        // Генерируем кнопки
        let html = `
            <button class="tab-button active" data-type="" onclick="filterByType('')" 
                    title="Показать все лицензии" aria-label="Показать все лицензии">
                <span class="tab-color-indicator" style="background-color: var(--accent-color);"></span>
                Все <span class="tab-count" id="countAll">0</span>
            </button>
        `;

        uniqueTypes.forEach(type => {
            const description = getLicenseTypeDescription(type);
            const color = getColorByUsageType(type);
            html += `
            <button class="tab-button" data-type="${type}" onclick="filterByType('${type}')"
                    title="${description}" aria-label="Фильтр: ${type} - ${description}"
                    style="--type-color: ${color};">
                <span class="tab-color-indicator" style="background-color: ${color};"></span>
                ${type} <span class="tab-count" id="count-${type}">0</span>
            </button>
            `;
        });

        container.innerHTML = html;
    }

    function generateMapLegend() {
        const container = document.getElementById('legendItems');
        if (!container) return;

        // Получаем уникальные типы лицензий
        const uniqueTypes = [...new Set(allLicenses.map(l => l.license_type))].sort();

        // Генерируем элементы легенды
        let html = '';
        uniqueTypes.forEach(type => {
            const color = getColorByUsageType(type);
            const description = getLicenseTypeDescription(type);
            html += `
                <div class="legend-item">
                    <span class="legend-color" style="background-color: ${color};"></span>
                    ${type} - ${description}
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function getLicenseTypeDescription(type) {
        // Здесь можно добавить описания для известных типов
        const descriptions = {
            'БЭ': 'Благородные металлы, разведка и добыча',
            'БП': 'Благородные металлы, геологическое изучение',
            'БР': 'Благородные металлы, совмещенное пользование – для геологического изучения, разведки и добычи',
            'ТП': 'Твердые полезные, геологическое изучение'
        };
        return descriptions[type] || 'Пользование недрами';
    }

    function filterByType(type) {
        // Обновляем активный таб
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('.tab-button').classList.add('active');

        // Устанавливаем фильтр по типу
        document.getElementById('filterType').value = type;

        // Применяем фильтры
        applyFilters();
    }

    function populateFilters() {
        const regions = [...new Set(allLicenses.map(l => l.region))].sort();
        const types = [...new Set(allLicenses.map(l => l.license_type))].sort();
        const minerals = [...new Set(allLicenses.map(l => l.mineral_type).filter(m => m))].sort();

        const regionSelect = document.getElementById('filterRegion');
        // Очищаем старые опции, оставляя только первую ("Все регионы")
        while (regionSelect.options.length > 1) {
            regionSelect.remove(1);
        }
        regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.textContent = region;
            regionSelect.appendChild(option);
        });

        const typeSelect = document.getElementById('filterType');
        // Очищаем старые опции, оставляя только первую ("Все виды")
        while (typeSelect.options.length > 1) {
            typeSelect.remove(1);
        }
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
        });

        const mineralSelect = document.getElementById('filterMineral');
        // Очищаем старые опции, оставляя только первую ("Все виды")
        while (mineralSelect.options.length > 1) {
            mineralSelect.remove(1);
        }
        minerals.forEach(mineral => {
            const option = document.createElement('option');
            option.value = mineral;
            option.textContent = mineral;
            mineralSelect.appendChild(option);
        });
    }

    function applyFilters() {
        const statusFilter = document.getElementById('filterStatus').value;
        const regionFilter = document.getElementById('filterRegion').value;
        const typeFilter = document.getElementById('filterType').value;
        const mineralFilter = document.getElementById('filterMineral').value;
        const searchText = document.getElementById('searchText').value.toLowerCase();

        // Проверяем, применены ли фильтры
        const hasActiveFilters = statusFilter || regionFilter || typeFilter || mineralFilter || searchText;

        filteredLicenses = allLicenses.filter(license => {
            if (statusFilter && license.status !== statusFilter) return false;
            if (regionFilter && license.region !== regionFilter) return false;
            if (typeFilter && license.license_type !== typeFilter) return false;
            if (mineralFilter && license.mineral_type !== mineralFilter) return false;
            if (searchText && !license.license_number.toLowerCase().includes(searchText) &&
                !license.owner.toLowerCase().includes(searchText)) return false;
            return true;
        });

        if (hasActiveFilters) {
            // Переключаемся на клиентскую пагинацию
            currentFiltersActive = true;
            displayFilteredPage(1);
        } else {
            // Если фильтров нет, возвращаемся к серверной пагинации
            currentFiltersActive = false;
            loadLicenses(1);
        }
    }

    function resetFilters() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterRegion').value = '';
        document.getElementById('filterType').value = '';
        document.getElementById('filterMineral').value = '';
        document.getElementById('searchText').value = '';

        // Сбрасываем активный таб
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.tab-button[data-type=""]').classList.add('active');

        // Возвращаемся к серверной пагинации
        currentFiltersActive = false;
        loadLicenses(1);
    }

    function showExportSpinner() {
        const spinner = document.querySelector('.export-spinner');
        if (spinner) {
            spinner.style.display = 'block';
        }
    }

    function hideExportSpinner() {
        const spinner = document.querySelector('.export-spinner');
        if (spinner) {
            spinner.style.display = 'none';
        }
    }

    function exportToExcel() {
        // Показываем индикатор загрузки
        showExportSpinner();

        // Собираем текущие параметры фильтров
        const params = new URLSearchParams();

        const statusFilter = document.getElementById('filterStatus').value;
        const regionFilter = document.getElementById('filterRegion').value;
        const typeFilter = document.getElementById('filterType').value;
        const mineralFilter = document.getElementById('filterMineral').value;
        const searchText = document.getElementById('searchText').value;

        if (statusFilter) params.append('status', statusFilter);
        if (regionFilter) params.append('region', regionFilter);
        if (typeFilter) params.append('type', typeFilter);
        if (mineralFilter) params.append('mineral', mineralFilter);
        if (searchText) params.append('search', searchText);

        // Формируем URL для экспорта
        const exportUrl = `/api/licenses/export/excel/?${params.toString()}`;

        // Открываем ссылку для скачивания
        window.location.href = exportUrl;

        // Скрываем индикатор через 2 секунды
        setTimeout(hideExportSpinner, 2000);
    }

    function exportToPDF() {
        // Показываем индикатор загрузки
        showExportSpinner();

        // Собираем текущие параметры фильтров
        const params = new URLSearchParams();

        const statusFilter = document.getElementById('filterStatus').value;
        const regionFilter = document.getElementById('filterRegion').value;
        const typeFilter = document.getElementById('filterType').value;
        const mineralFilter = document.getElementById('filterMineral').value;
        const searchText = document.getElementById('searchText').value;

        if (statusFilter) params.append('status', statusFilter);
        if (regionFilter) params.append('region', regionFilter);
        if (typeFilter) params.append('type', typeFilter);
        if (mineralFilter) params.append('mineral', mineralFilter);
        if (searchText) params.append('search', searchText);

        // Формируем URL для экспорта
        const exportUrl = `/api/licenses/export/pdf/?${params.toString()}`;

        // Открываем ссылку для скачивания
        window.location.href = exportUrl;

        // Скрываем индикатор через 2 секунды
        setTimeout(hideExportSpinner, 2000);
    }

    function updateResultsCount() {
        const count = filteredLicenses.length;
        const total = allLicenses.length;
        document.getElementById('resultsCount').textContent = `Найдено: ${count} из ${total}`;
    }

    function displayLicenses() {
        const container = document.getElementById('licensesList');

        if (filteredLicenses.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-5">Лицензии не найдены</p>';
            return;
        }

        container.innerHTML = filteredLicenses.map(license => `
        <div class="license-card" onclick="showLicenseDetails(${license.id})">
            <div class="d-flex justify-content-between align-items-start">
                <div class="license-card-title">${license.license_number}</div>
                <span class="status-badge status-${license.status}">${getStatusText(license.status)}</span>
            </div>
            <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">${license.owner}</p>
            
            <div class="license-meta">
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Регион</div>
                        <div class="meta-value">${license.region}</div>
                    </div>
                </div>
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Тип</div>
                        <div class="meta-value">${license.license_type}</div>
                    </div>
                </div>
                ${license.mineral_type ? `
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Полезное ископаемое</div>
                        <div class="meta-value">${license.mineral_type}</div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `).join('');

        updateResultsCount();
    }

    function displayFilteredPage(pageNum) {
        currentPage = pageNum;

        const start = (pageNum - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pageData = filteredLicenses.slice(start, end);

        const container = document.getElementById('licensesList');

        if (filteredLicenses.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-5">Лицензии не найдены</p>';
            updatePagination(0, 1, true);
            return;
        }

        container.innerHTML = pageData.map(license => `
        <div class="license-card" onclick="showLicenseDetails(${license.id})">
            <div class="d-flex justify-content-between align-items-start">
                <div class="license-card-title">${license.license_number}</div>
                <span class="status-badge status-${license.status}">${getStatusText(license.status)}</span>
            </div>
            <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">${license.owner}</p>
            
            <div class="license-meta">
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Регион</div>
                        <div class="meta-value">${license.region}</div>
                    </div>
                </div>
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Тип</div>
                        <div class="meta-value">${license.license_type}</div>
                    </div>
                </div>
                ${license.mineral_type ? `
                <div class="meta-item">
                    <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <div class="meta-content">
                        <div class="meta-label">Полезное ископаемое</div>
                        <div class="meta-value">${license.mineral_type}</div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
        `).join('');

        updatePagination(filteredLicenses.length, pageNum, true);
        displayLicensesOnMap();
        updateResultsCount();
    }

    // Функция для вычисления примерной площади полигона (формула Shoelace)
    function calculatePolygonArea(license) {
        if (!license.polygon_data || !license.polygon_data.coordinates) {
            // Если нет полигона, возвращаем 0 (для точек используем минимальное значение)
            return license.latitude && license.longitude ? 0.0001 : 0;
        }

        const geomType = license.polygon_data.type;
        let totalArea = 0;

        if (geomType === 'Polygon') {
            // Для простого полигона берем первый ring (внешний контур)
            const ring = license.polygon_data.coordinates[0];
            if (ring && ring.length > 2) {
                let area = 0;
                for (let i = 0; i < ring.length - 1; i++) {
                    area += ring[i][0] * ring[i + 1][1];
                    area -= ring[i + 1][0] * ring[i][1];
                }
                totalArea = Math.abs(area) / 2;
            }
        } else if (geomType === 'MultiPolygon') {
            // Для MultiPolygon суммируем площади всех полигонов
            license.polygon_data.coordinates.forEach(polygonCoords => {
                const ring = polygonCoords[0]; // Внешний контур каждого полигона
                if (ring && ring.length > 2) {
                    let area = 0;
                    for (let i = 0; i < ring.length - 1; i++) {
                        area += ring[i][0] * ring[i + 1][1];
                        area -= ring[i + 1][0] * ring[i][1];
                    }
                    totalArea += Math.abs(area) / 2;
                }
            });
        }

        return totalArea;
    }

    function displayLicensesOnMap() {
        // Удаляем старые метки
        myMap.geoObjects.removeAll();
        placemarks = [];

        // Используем все лицензии если фильтры не применены, иначе только отфильтрованные
        let licensesToDisplay = currentFiltersActive ? filteredLicenses : allLicenses;
        
        // Сортируем лицензии по площади полигона (большие первыми, маленькие последними)
        // Это обеспечит, что маленькие полигоны будут отрисовываться поверх больших
        licensesToDisplay = [...licensesToDisplay].sort((a, b) => {
            const areaA = calculatePolygonArea(a);
            const areaB = calculatePolygonArea(b);
            return areaB - areaA; // Сортировка по убыванию (большие первыми)
        });

        licensesToDisplay.forEach(license => {
            let geoObject;

            // Проверяем, есть ли полигон
            if (license.polygon_data && license.polygon_data.coordinates) {
                const geomType = license.polygon_data.type;

                // GeoJSON использует [longitude, latitude], а Яндекс [latitude, longitude]
                if (geomType === 'Polygon') {
                    // Простой полигон - конвертируем координаты
                    const convertedCoords = license.polygon_data.coordinates.map(ring =>
                        ring.map(coord => [coord[1], coord[0]])
                    );
                    geoObject = new ymaps.Polygon(
                        convertedCoords,
                        {
                            balloonContentHeader: `<strong>${license.license_number}</strong>`,
                            balloonContentBody: `
                        <div class="license-info">
                            <p><strong>Недропользователь:</strong> ${license.owner}</p>
                            <p><strong>Регион:</strong> ${license.region}</p>
                            <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                            <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                Подробнее
                            </button>
                        </div>
                    `,
                            hintContent: license.license_number
                        },
                        {
                            fillColor: getColorByUsageType(license.license_type),
                            fillOpacity: 0.2,
                            strokeColor: getColorByUsageType(license.license_type),
                            strokeWidth: 3,
                            strokeOpacity: 1.0
                        }
                    );
                    geoObject.properties.set('licenseId', license.id);
                } else if (geomType === 'MultiPolygon') {
                    // MultiPolygon - создаем коллекцию полигонов
                    const collection = new ymaps.GeoObjectCollection();
                    license.polygon_data.coordinates.forEach(polygonCoords => {
                        const convertedCoords = polygonCoords.map(ring =>
                            ring.map(coord => [coord[1], coord[0]])
                        );
                        const polygon = new ymaps.Polygon(
                            convertedCoords,
                            {
                                balloonContentHeader: `<strong>${license.license_number}</strong>`,
                                balloonContentBody: `
                                <div class="license-info">
                                    <p><strong>Недропользователь:</strong> ${license.owner}</p>
                                    <p><strong>Регион:</strong> ${license.region}</p>
                                    <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                                    <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                                    <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                        Подробнее
                                    </button>
                                </div>
                            `,
                                hintContent: license.license_number
                            },
                            {
                                fillColor: getColorByUsageType(license.license_type),
                                fillOpacity: 0.2,
                                strokeColor: getColorByUsageType(license.license_type),
                                strokeWidth: 3,
                                strokeOpacity: 1.0
                            }
                        );
                        collection.add(polygon);
                    });
                    geoObject = collection;
                    geoObject.properties.set('licenseId', license.id);
                }
            } else if (license.latitude && license.longitude) {
                // Создаём точку (для обратной совместимости)
                geoObject = new ymaps.Placemark(
                    [license.latitude, license.longitude],
                    {
                        balloonContentHeader: `<strong>${license.license_number}</strong>`,
                        balloonContentBody: `
                        <div class="license-info">
                            <p><strong>Недропользователь:</strong> ${license.owner}</p>
                            <p><strong>Регион:</strong> ${license.region}</p>
                            <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                            <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                Подробнее
                            </button>
                        </div>
                    `,
                        hintContent: license.license_number
                    },
                    {
                        preset: getPresetByUsageType(license.license_type)
                    }
                );
                geoObject.properties.set('licenseId', license.id);
            }

            if (geoObject) {
                myMap.geoObjects.add(geoObject);
                placemarks.push(geoObject);
            }
        });

        console.log(`Отображено объектов на карте: ${placemarks.length}`);

        // Автоматически подстраиваем границы карты под объекты
        if (placemarks.length > 0) {
            try {
                const bounds = myMap.geoObjects.getBounds();
                console.log('Границы объектов:', bounds);
                myMap.setBounds(bounds, {
                    checkZoomRange: true,
                    zoomMargin: 100,
                    duration: 500
                });
            } catch (e) {
                console.error('Ошибка установки границ:', e);
            }
        } else {
            console.warn('Нет объектов для отображения на карте');
        }
    }

    function getColorByUsageType(usageType) {
        const colors = {
            'БЭ': '#60A5FA',
            'БП': '#27ae60',
            'БР': '#e67e22',
            'ТП': '#1abc9c',
            'ПВ': '#9b59b6',
            'ГС': '#f39c12',
            'КП': '#e74c3c',
            'РП': '#16a085',
            'СП': '#8e44ad',
            'УВС': '#2c3e50'
        };
        return colors[usageType] || '#95a5a6';
    }

    function getColorByStatus(status) {
        const colors = {
            'active': '#28a745',
            'expired': '#6c757d',
            'suspended': '#ffc107',
            'terminated': '#dc3545'
        };
        return colors[status] || '#60A5FA';
    }

    function getStatusText(status) {
        const statuses = {
            'active': 'Действующая',
            'expired': 'Истекла',
            'suspended': 'Приостановлена',
            'terminated': 'Прекращена'
        };
        return statuses[status] || status;
    }

    function getPresetByUsageType(usageType) {
        const presets = {
            'БЭ': 'islands#blueDotIcon',
            'БП': 'islands#greenDotIcon',
            'БР': 'islands#orangeDotIcon',
            'ТП': 'islands#lightBlueDotIcon',
            'ПВ': 'islands#violetDotIcon',
            'ГС': 'islands#yellowDotIcon',
            'КП': 'islands#redDotIcon',
            'РП': 'islands#darkGreenDotIcon',
            'СП': 'islands#darkBlueDotIcon',
            'УВС': 'islands#grayDotIcon'
        };
        return presets[usageType] || 'islands#grayDotIcon';
    }

    function getPresetByStatus(status) {
        const presets = {
            'active': 'islands#greenDotIcon',
            'expired': 'islands#grayDotIcon',
            'suspended': 'islands#yellowDotIcon',
            'terminated': 'islands#redDotIcon'
        };
        return presets[status] || 'islands#blueDotIcon';
    }

    let currentLicense = null;

    function showLicenseDetails(licenseId) {
        currentLicenseId = licenseId;
        fetch(`/api/licenses/${licenseId}/`)
            .then(response => response.json())
            .then(license => {
                currentLicense = license;
                document.getElementById('modalTitle').innerHTML = `Лицензия ${license.license_number}`;

                let documentsHtml = '';
                if (license.documents && license.documents.length > 0) {
                    documentsHtml = '<h6 class="mt-3">Документы:</h6><ul class="list-group">';
                    license.documents.forEach(doc => {
                        documentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${doc.title}
                            <a href="/api/documents/${doc.id}/download/" class="btn btn-sm btn-outline-primary">
                                Скачать
                            </a>
                        </li>
                    `;
                    });
                    documentsHtml += '</ul>';
                } else {
                    documentsHtml = '<p class="text-muted mt-3">Нет прикрепленных документов</p>';
                }

                document.getElementById('modalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Номер лицензии:</strong> ${license.license_number}</p>
                        <p><strong>Недропользователь:</strong> ${license.owner}</p>
                        <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                        <p><strong>Регион:</strong> ${license.region}</p>
                        <p><strong>Участок недр:</strong> ${license.area || 'Не указан'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Дата выдачи:</strong> ${license.issue_date}</p>
                        <p><strong>Дата окончания:</strong> ${license.expiry_date || 'Не указана'}</p>
                        <p><strong>Полезное ископаемое:</strong> ${license.mineral_type || 'Не указано'}</p>
                        <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                        <p><strong>Координаты:</strong> ${license.latitude}, ${license.longitude}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Описание:</strong></p>
                        <p>${license.description || 'Нет описания'}</p>
                    </div>
                </div>
                ${documentsHtml}
            `;

                const modal = new bootstrap.Modal(document.getElementById('licenseModal'));
                modal.show();
            })
            .catch(error => console.error('Ошибка загрузки деталей лицензии:', error));
    }

    function showUploadForm() {
        if (!currentLicenseId) {
            alert('Лицензия не выбрана');
            return;
        }

        const fileInput = document.createElement('input');

        fileInput.type = 'file';
        fileInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.jpg,.png';

        fileInput.onchange = () => {
            if (fileInput.files.length === 0) return;

            const selectedFile = fileInput.files[0];
            const defaultTitle = selectedFile.name;

            const title = prompt('Название документа:', defaultTitle);
            if (!title) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('title', title);
            formData.append('file_type', 'other');

            fetch(`/api/licenses/${currentLicenseId}/upload/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Документ успешно загружен');
                        showLicenseDetails(currentLicenseId);
                    } else {
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки документа:', error);
                    alert('Ошибка загрузки документа');
                });
        };

        fileInput.click();
    }

    function showOnMap() {
        if (!currentLicense) {
            alert('Лицензия не загружена');
            return;
        }

        // Закрываем модальное окно
        const modal = bootstrap.Modal.getInstance(document.getElementById('licenseModal'));
        modal.hide();

        // Прокручиваем к карте
        document.querySelector('.map-container').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        // Центрируем карту на точном местоположении лицензии с увеличенным зумом
        setTimeout(() => {
            myMap.setCenter([currentLicense.latitude, currentLicense.longitude], 15, {
                checkZoomRange: true,
                duration: 500
            });

            // Находим соответствующий маркер по ID лицензии и открываем его балун
            setTimeout(() => {
                // Ищем placemark по ID лицензии из properties
                const targetPlacemark = placemarks.find(placemark => {
                    const licenseId = placemark.properties.get('licenseId');
                    return licenseId === currentLicense.id;
                });

                if (targetPlacemark) {
                    targetPlacemark.balloon.open();
                }
            }, 600);
        }, 300);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Back to top button functionality
    const backToTopButton = document.getElementById('backToTop');

    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
            backToTopButton.classList.add('show');
        } else {
            backToTopButton.classList.remove('show');
        }
    });

    backToTopButton.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // Функция для сворачивания/разворачивания легенды
    function toggleLegend() {
        const legend = document.getElementById('mapLegend');
        const header = legend?.querySelector('.legend-header');
        if (legend && header) {
            const isCollapsed = legend.classList.toggle('collapsed');
            header.setAttribute('aria-expanded', !isCollapsed);
            // Обновляем подсказку
            header.setAttribute('title', isCollapsed ? 'Нажмите, чтобы развернуть легенду' : 'Нажмите, чтобы свернуть легенду');
        }
    }

    // Инициализация подсказки при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        const legendHeader = document.querySelector('.legend-header');
        if (legendHeader) {
            const legend = document.getElementById('mapLegend');
            const isCollapsed = legend?.classList.contains('collapsed');
            legendHeader.setAttribute('title', isCollapsed ? 'Нажмите, чтобы развернуть легенду' : 'Нажмите, чтобы свернуть легенду');
        }
    });

    // Поддержка клавиатуры для легенды
    document.addEventListener('DOMContentLoaded', function() {
        const legendHeader = document.querySelector('.legend-header');
        if (legendHeader) {
            legendHeader.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleLegend();
                }
            });
        }
    });

    // Инициализация Bootstrap tooltips
    document.addEventListener('DOMContentLoaded', function () {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}