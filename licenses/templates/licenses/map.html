{% extends 'licenses/base.html' %}

{% block title %}Интерактивная карта лицензий{% endblock %}

{% block extra_css %}
<style>
    body {
        overflow-y: auto;
    }

    .main-container {
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 100px);
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
    }

    .content-area {
        flex: 1;
    }

    .map-container {
        width: 100%;
        height: 500px;
        margin-bottom: 2rem;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1.5rem;
        letter-spacing: -0.025em;
    }

    .filters-section {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }

    .filters-section h5 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1.5rem;
        letter-spacing: -0.025em;
    }

    .licenses-list {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }

    .licenses-list h5 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1.5rem;
        letter-spacing: -0.025em;
    }

    .license-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .license-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: var(--accent-color);
    }

    .license-card h6 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.75rem;
    }

    .license-card p {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .license-card strong {
        color: var(--text-dark);
        font-weight: 600;
    }

    .status-badge {
        display: inline-block;
        padding: 0.375rem 0.875rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .status-active {
        background-color: #d1fae5;
        color: var(--success-color);
    }

    .status-expired {
        background-color: #e2e8f0;
        color: #64748b;
    }

    .status-suspended {
        background-color: #fed7aa;
        color: var(--warning-color);
    }

    .status-terminated {
        background-color: #fecaca;
        color: var(--danger-color);
    }

    .filter-group {
        margin-bottom: 1.25rem;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
        color: var(--text-dark);
        font-size: 0.875rem;
    }

    .form-select, .form-control {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.625rem 1rem;
        transition: all 0.2s;
        font-size: 0.9375rem;
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .btn {
        border-radius: 8px;
        padding: 0.625rem 1.25rem;
        font-weight: 600;
        transition: all 0.2s;
        border: none;
    }

    .btn-secondary {
        background-color: var(--text-muted);
        color: white;
    }

    .btn-secondary:hover {
        background-color: #4a5568;
        transform: translateY(-1px);
    }

    .btn-info {
        background-color: var(--accent-color);
        color: white;
    }

    .btn-info:hover {
        background-color: var(--accent-hover);
    }

    .btn-primary {
        background-color: var(--accent-color);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--accent-hover);
        transform: translateY(-1px);
    }

    .legend {
        background: white;
        padding: 1.25rem;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        font-size: 0.875rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }

    .legend-title {
        font-weight: 700;
        margin-bottom: 1rem;
        font-size: 1rem;
        color: var(--text-dark);
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 1.5rem;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-dark);
    }

    .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        margin-right: 0.5rem;
        border: 2px solid rgba(0, 0, 0, 0.1);
    }

    .results-count {
        font-weight: 500;
        color: var(--text-muted);
        font-size: 0.9375rem;
    }

    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        border-bottom: none;
        padding: 1.5rem;
    }

    .modal-title {
        font-weight: 700;
        font-size: 1.25rem;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
        padding: 1.25rem 1.5rem;
    }

    .btn-close {
        filter: brightness(0) invert(1);
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Карта вверху в аккуратном окошке -->
    <div class="map-container">
        <div id="map"></div>
    </div>

    <!-- Основная область контента -->
    <div class="content-area">
        <!-- Легенда цветов -->
        <div class="legend">
            <div class="legend-title">Цвета полигонов по виду пользования недрами</div>
            <div class="d-flex flex-wrap">
                <div class="legend-item"><span class="legend-color" style="background-color: #3498db;"></span>БЭ </div>
                <div class="legend-item"><span class="legend-color" style="background-color: #27ae60;"></span>БП</div>
                <div class="legend-item"><span class="legend-color" style="background-color: #e67e22;"></span>БР</div>
                <div class="legend-item"><span class="legend-color" style="background-color: #1abc9c;"></span>ТП</div>
            </div>
        </div>

        <!-- Фильтры -->
        <div class="filters-section">
            <h5 class="mb-3">Фильтры лицензий</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterStatus">Статус:</label>
                        <select id="filterStatus" class="form-select" onchange="applyFilters()">
                            <option value="">Все статусы</option>
                            <option value="active">Действующая</option>
                            <option value="expired">Истекла</option>
                            <option value="suspended">Приостановлена</option>
                            <option value="terminated">Прекращена</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterRegion">Регион:</label>
                        <select id="filterRegion" class="form-select" onchange="applyFilters()">
                            <option value="">Все регионы</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterType">Вид пользования:</label>
                        <select id="filterType" class="form-select" onchange="applyFilters()">
                            <option value="">Все виды</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-group">
                        <label for="filterMineral">Полезное ископаемое:</label>
                        <select id="filterMineral" class="form-select" onchange="applyFilters()">
                            <option value="">Все виды</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="filter-group">
                        <label for="searchText">Поиск:</label>
                        <input type="text" id="searchText" class="form-control"
                            placeholder="Номер лицензии или недропользователь..." onkeyup="applyFilters()">
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="resetFilters()">Сбросить фильтры</button>
            <span class="ms-3 results-count" id="resultsCount"></span>
        </div>

        <!-- Список лицензий -->
        <div class="licenses-list">
            <h5 class="mb-3">Список лицензий</h5>
            <div id="licensesList">
                <!-- Здесь будут карточки лицензий -->
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для детальной информации о лицензии -->
<div class="modal fade" id="licenseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Информация о лицензии</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Здесь будет отображаться детальная информация -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" onclick="showOnMap()">Показать на карте</button>
                {% if user.is_authenticated %}
                <button type="button" class="btn btn-primary" onclick="showUploadForm()">Загрузить документ</button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU"
    type="text/javascript"></script>
<script>
    let currentLicenseId = null;
    let myMap;
    let allLicenses = [];
    let filteredLicenses = [];
    let placemarks = [];

    ymaps.ready(init);

    function init() {
        myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 5,
            controls: ['zoomControl', 'searchControl', 'typeSelector', 'fullscreenControl']
        });

        loadLicenses();
    }

    function loadLicenses() {
        fetch('/api/licenses/')
            .then(response => response.json())
            .then(data => {
                console.log(`Загружено лицензий: ${data.length}`);
                allLicenses = data;
                filteredLicenses = data;

                // Заполняем фильтры уникальными значениями
                populateFilters();

                // Отображаем лицензии
                displayLicenses();
                displayLicensesOnMap();
            })
            .catch(error => console.error('Ошибка загрузки лицензий:', error));
    }

    function populateFilters() {
        const regions = [...new Set(allLicenses.map(l => l.region))].sort();
        const types = [...new Set(allLicenses.map(l => l.license_type))].sort();
        const minerals = [...new Set(allLicenses.map(l => l.mineral_type).filter(m => m))].sort();

        const regionSelect = document.getElementById('filterRegion');
        regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.textContent = region;
            regionSelect.appendChild(option);
        });

        const typeSelect = document.getElementById('filterType');
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
        });

        const mineralSelect = document.getElementById('filterMineral');
        minerals.forEach(mineral => {
            const option = document.createElement('option');
            option.value = mineral;
            option.textContent = mineral;
            mineralSelect.appendChild(option);
        });
    }

    function applyFilters() {
        const statusFilter = document.getElementById('filterStatus').value;
        const regionFilter = document.getElementById('filterRegion').value;
        const typeFilter = document.getElementById('filterType').value;
        const mineralFilter = document.getElementById('filterMineral').value;
        const searchText = document.getElementById('searchText').value.toLowerCase();

        filteredLicenses = allLicenses.filter(license => {
            if (statusFilter && license.status !== statusFilter) return false;
            if (regionFilter && license.region !== regionFilter) return false;
            if (typeFilter && license.license_type !== typeFilter) return false;
            if (mineralFilter && license.mineral_type !== mineralFilter) return false;
            if (searchText && !license.license_number.toLowerCase().includes(searchText) &&
                !license.owner.toLowerCase().includes(searchText)) return false;
            return true;
        });

        displayLicenses();
        displayLicensesOnMap();
        updateResultsCount();
    }

    function resetFilters() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterRegion').value = '';
        document.getElementById('filterType').value = '';
        document.getElementById('filterMineral').value = '';
        document.getElementById('searchText').value = '';
        applyFilters();
    }

    function updateResultsCount() {
        const count = filteredLicenses.length;
        const total = allLicenses.length;
        document.getElementById('resultsCount').textContent = `Найдено: ${count} из ${total}`;
    }

    function displayLicenses() {
        const container = document.getElementById('licensesList');

        if (filteredLicenses.length === 0) {
            container.innerHTML = '<p class="text-muted">Лицензии не найдены</p>';
            return;
        }

        container.innerHTML = filteredLicenses.map(license => `
        <div class="license-card" onclick="showLicenseDetails(${license.id})">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0">${license.license_number}</h6>
                <span class="status-badge status-${license.status}">${getStatusText(license.status)}</span>
            </div>
            <p class="mb-1"><strong>Недропользователь:</strong> ${license.owner}</p>
            <p class="mb-1"><strong>Регион:</strong> ${license.region}</p>
            <p class="mb-0 text-muted small">${license.license_type}</p>
        </div>
    `).join('');

        updateResultsCount();
    }

    function displayLicensesOnMap() {
        // Удаляем старые метки
        myMap.geoObjects.removeAll();
        placemarks = [];

        filteredLicenses.forEach(license => {
            let geoObject;

            // Проверяем, есть ли полигон
            if (license.polygon_data && license.polygon_data.coordinates) {
                const geomType = license.polygon_data.type;

                // GeoJSON использует [longitude, latitude], а Яндекс [latitude, longitude]
                if (geomType === 'Polygon') {
                    // Простой полигон - конвертируем координаты
                    const convertedCoords = license.polygon_data.coordinates.map(ring =>
                        ring.map(coord => [coord[1], coord[0]])
                    );
                    geoObject = new ymaps.Polygon(
                        convertedCoords,
                        {
                            balloonContentHeader: `<strong>${license.license_number}</strong>`,
                            balloonContentBody: `
                        <div class="license-info">
                            <p><strong>Недропользователь:</strong> ${license.owner}</p>
                            <p><strong>Регион:</strong> ${license.region}</p>
                            <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                            <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                Подробнее
                            </button>
                        </div>
                    `,
                            hintContent: license.license_number
                        },
                        {
                            fillColor: getColorByUsageType(license.license_type),
                            fillOpacity: 0.3,
                            strokeColor: getColorByUsageType(license.license_type),
                            strokeWidth: 2,
                            strokeOpacity: 0.8
                        }
                    );
                } else if (geomType === 'MultiPolygon') {
                    // MultiPolygon - создаем коллекцию полигонов
                    const collection = new ymaps.GeoObjectCollection();
                    license.polygon_data.coordinates.forEach(polygonCoords => {
                        const convertedCoords = polygonCoords.map(ring =>
                            ring.map(coord => [coord[1], coord[0]])
                        );
                        const polygon = new ymaps.Polygon(
                            convertedCoords,
                            {
                                balloonContentHeader: `<strong>${license.license_number}</strong>`,
                                balloonContentBody: `
                                <div class="license-info">
                                    <p><strong>Недропользователь:</strong> ${license.owner}</p>
                                    <p><strong>Регион:</strong> ${license.region}</p>
                                    <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                                    <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                                    <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                        Подробнее
                                    </button>
                                </div>
                            `,
                                hintContent: license.license_number
                            },
                            {
                                fillColor: getColorByUsageType(license.license_type),
                                fillOpacity: 0.3,
                                strokeColor: getColorByUsageType(license.license_type),
                                strokeWidth: 2,
                                strokeOpacity: 0.8
                            }
                        );
                        collection.add(polygon);
                    });
                    geoObject = collection;
                }
            } else if (license.latitude && license.longitude) {
                // Создаём точку (для обратной совместимости)
                geoObject = new ymaps.Placemark(
                    [license.latitude, license.longitude],
                    {
                        balloonContentHeader: `<strong>${license.license_number}</strong>`,
                        balloonContentBody: `
                        <div class="license-info">
                            <p><strong>Недропользователь:</strong> ${license.owner}</p>
                            <p><strong>Регион:</strong> ${license.region}</p>
                            <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                            <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showLicenseDetails(${license.id})">
                                Подробнее
                            </button>
                        </div>
                    `,
                        hintContent: license.license_number
                    },
                    {
                        preset: getPresetByUsageType(license.license_type)
                    }
                );
            }

            if (geoObject) {
                myMap.geoObjects.add(geoObject);
                placemarks.push(geoObject);
            }
        });

        console.log(`Отображено объектов на карте: ${placemarks.length}`);

        // Автоматически подстраиваем границы карты под объекты
        if (placemarks.length > 0) {
            try {
                const bounds = myMap.geoObjects.getBounds();
                console.log('Границы объектов:', bounds);
                myMap.setBounds(bounds, {
                    checkZoomRange: true,
                    zoomMargin: 100,
                    duration: 500
                });
            } catch (e) {
                console.error('Ошибка установки границ:', e);
            }
        } else {
            console.warn('Нет объектов для отображения на карте');
        }
    }

    function getColorByUsageType(usageType) {
        const colors = {
            'БЭ': '#3498db',
            'БП': '#27ae60',
            'БР': '#e67e22',
            'ТП': '#1abc9c',
            'ПВ': '#9b59b6',
            'ГС': '#f39c12',
            'КП': '#e74c3c',
            'РП': '#16a085',
            'СП': '#8e44ad',
            'УВС': '#2c3e50'
        };
        return colors[usageType] || '#95a5a6';
    }

    function getColorByStatus(status) {
        const colors = {
            'active': '#28a745',
            'expired': '#6c757d',
            'suspended': '#ffc107',
            'terminated': '#dc3545'
        };
        return colors[status] || '#007bff';
    }

    function getStatusText(status) {
        const statuses = {
            'active': 'Действующая',
            'expired': 'Истекла',
            'suspended': 'Приостановлена',
            'terminated': 'Прекращена'
        };
        return statuses[status] || status;
    }

    function getPresetByUsageType(usageType) {
        const presets = {
            'БЭ': 'islands#blueDotIcon',
            'БП': 'islands#greenDotIcon',
            'БР': 'islands#orangeDotIcon',
            'ТП': 'islands#lightBlueDotIcon',
            'ПВ': 'islands#violetDotIcon',
            'ГС': 'islands#yellowDotIcon',
            'КП': 'islands#redDotIcon',
            'РП': 'islands#darkGreenDotIcon',
            'СП': 'islands#darkBlueDotIcon',
            'УВС': 'islands#grayDotIcon'
        };
        return presets[usageType] || 'islands#grayDotIcon';
    }

    function getPresetByStatus(status) {
        const presets = {
            'active': 'islands#greenDotIcon',
            'expired': 'islands#grayDotIcon',
            'suspended': 'islands#yellowDotIcon',
            'terminated': 'islands#redDotIcon'
        };
        return presets[status] || 'islands#blueDotIcon';
    }

    let currentLicense = null;

    function showLicenseDetails(licenseId) {
        currentLicenseId = licenseId;
        fetch(`/api/licenses/${licenseId}/`)
            .then(response => response.json())
            .then(license => {
                currentLicense = license;
                document.getElementById('modalTitle').innerHTML = `Лицензия ${license.license_number}`;

                let documentsHtml = '';
                if (license.documents && license.documents.length > 0) {
                    documentsHtml = '<h6 class="mt-3">Документы:</h6><ul class="list-group">';
                    license.documents.forEach(doc => {
                        documentsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${doc.title}
                            <a href="/api/documents/${doc.id}/download/" class="btn btn-sm btn-outline-primary">
                                Скачать
                            </a>
                        </li>
                    `;
                    });
                    documentsHtml += '</ul>';
                } else {
                    documentsHtml = '<p class="text-muted mt-3">Нет прикрепленных документов</p>';
                }

                document.getElementById('modalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Номер лицензии:</strong> ${license.license_number}</p>
                        <p><strong>Недропользователь:</strong> ${license.owner}</p>
                        <p><strong>Вид пользования:</strong> ${license.license_type}</p>
                        <p><strong>Регион:</strong> ${license.region}</p>
                        <p><strong>Участок недр:</strong> ${license.area || 'Не указан'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Дата выдачи:</strong> ${license.issue_date}</p>
                        <p><strong>Дата окончания:</strong> ${license.expiry_date || 'Не указана'}</p>
                        <p><strong>Полезное ископаемое:</strong> ${license.mineral_type || 'Не указано'}</p>
                        <p><strong>Статус:</strong> ${getStatusText(license.status)}</p>
                        <p><strong>Координаты:</strong> ${license.latitude}, ${license.longitude}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Описание:</strong></p>
                        <p>${license.description || 'Нет описания'}</p>
                    </div>
                </div>
                ${documentsHtml}
            `;

                const modal = new bootstrap.Modal(document.getElementById('licenseModal'));
                modal.show();
            })
            .catch(error => console.error('Ошибка загрузки деталей лицензии:', error));
    }

    function showUploadForm() {
        if (!currentLicenseId) {
            alert('Лицензия не выбрана');
            return;
        }

        const fileInput = document.createElement('input');

        fileInput.type = 'file';
        fileInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.jpg,.png';

        fileInput.onchange = () => {
            if (fileInput.files.length === 0) return;

            const selectedFile = fileInput.files[0];
            const defaultTitle = selectedFile.name;

            const title = prompt('Название документа:', defaultTitle);
            if (!title) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('title', title);
            formData.append('file_type', 'other');

            fetch(`/api/licenses/${currentLicenseId}/upload/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Документ успешно загружен');
                        showLicenseDetails(currentLicenseId);
                    } else {
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки документа:', error);
                    alert('Ошибка загрузки документа');
                });
        };

        fileInput.click();
    }

    function showOnMap() {
        if (!currentLicense) {
            alert('Лицензия не загружена');
            return;
        }

        // Закрываем модальное окно
        const modal = bootstrap.Modal.getInstance(document.getElementById('licenseModal'));
        modal.hide();

        // Прокручиваем к карте
        document.querySelector('.map-container').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        // Центрируем карту на точном местоположении лицензии с увеличенным зумом
        setTimeout(() => {
            myMap.setCenter([currentLicense.latitude, currentLicense.longitude], 15, {
                checkZoomRange: true,
                duration: 500
            });

            // Находим соответствующий маркер по ID лицензии и открываем его балун
            setTimeout(() => {
                const placemarkIndex = filteredLicenses.findIndex(license => license.id === currentLicense.id);

                if (placemarkIndex !== -1 && placemarks[placemarkIndex]) {
                    placemarks[placemarkIndex].balloon.open();
                }
            }, 600);
        }, 300);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}