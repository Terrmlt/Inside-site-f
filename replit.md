# База лицензий на недропользование

## Описание проекта

Веб-приложение на Django для управления базой данных лицензий на недропользование с интерактивной Яндекс.Картой.

## Основной функционал

### Реализованные функции
- ✅ Интерактивная Яндекс.Карта с отображением лицензий (40% экрана слева)
- ✅ Просмотр информации о лицензиях при клике на маркеры
- ✅ Модальные окна с детальной информацией о лицензии
- ✅ Функционал загрузки и скачивания документов
- ✅ **Фильтрация лицензий** по статусу, региону, типу, полезному ископаемому
- ✅ **Текстовый поиск** по номеру лицензии и недропользователю
- ✅ **Список лицензий** с карточками и синхронизацией с картой
- ✅ **Загрузка GeoJSON карт** через веб-интерфейс и админку (только для администраторов)
- ✅ Административная панель Django для управления данными
- ✅ Адаптивный интерфейс с разделением экрана (карта 40% + панель управления 60%)
- ✅ Заглушки для LDAP авторизации (готово к интеграции)
- ✅ Заглушки для подключения к внешней БД (готово к интеграции)

### Модели данных

**License (Лицензия)**
- Номер лицензии (уникальный)
- Вид пользования недрами
- Недропользователь
- Координаты (широта, долгота) для карты
- Регион и участок недр
- Даты выдачи и окончания
- Вид полезного ископаемого
- Статус (действующая, истекла, приостановлена, прекращена)
- Описание

**Document (Документ)**
- Связь с лицензией
- Название документа
- Файл
- Тип документа (лицензия, отчет, карта, прочее)
- Дата загрузки и пользователь

## Структура проекта

```
.
├── mineral_licenses/       # Основной проект Django
│   ├── settings.py        # Настройки проекта
│   ├── urls.py           # Главный URL конфигуратор
│   └── wsgi.py           # WSGI конфигурация
├── licenses/             # Приложение для управления лицензиями
│   ├── models.py         # Модели данных
│   ├── views.py          # Представления (views)
│   ├── urls.py           # URL маршруты
│   ├── admin.py          # Настройки админ-панели
│   ├── utils.py          # Утилиты (GeoJSON импорт)
│   ├── templates/        # HTML шаблоны
│   │   ├── licenses/
│   │   │   ├── base.html          # Базовый шаблон
│   │   │   ├── map.html           # Шаблон с картой
│   │   │   ├── login.html         # Форма входа
│   │   │   └── upload_geojson.html # Загрузка GeoJSON
│   │   └── admin/
│   │       └── licenses/
│   │           └── import_geojson.html # Админка: импорт GeoJSON
│   ├── management/
│   │   └── commands/
│   │       └── import_geojson.py  # Команда для импорта
│   └── migrations/       # Миграции БД
├── media/               # Загруженные документы
├── create_test_data.py  # Скрипт для создания тестовых данных
└── manage.py           # Django management команды
```

## Текущее состояние (28.10.2025)

**✅ База данных PostgreSQL:**
- Успешно настроена через Replit (Neon-backed PostgreSQL)
- Все миграции выполнены
- База данных подключена через переменную окружения `DATABASE_URL`
- Готова к использованию

**✅ Django сервер:**
- Запущен и работает на порту 5000
- Все зависимости установлены
- Готов к работе

**⚠️ Требуется настройка:**
- API ключ Яндекс.Карт (для отображения карты)
- Создание суперпользователя (для доступа к админке)

## Настройка и запуск

### 1. Настройка Яндекс.Карт API

**ВАЖНО:** Для работы интерактивной карты необходим API ключ Яндекс.Карт.

1. Получите бесплатный API ключ:
   - Перейдите на https://developer.tech.yandex.ru/
   - Зарегистрируйтесь или войдите
   - Выберите "JavaScript API и HTTP Геокодер"
   - Создайте новый ключ

2. Настройте переменную окружения:
   - Скопируйте `.env.example` в `.env`
   - Вставьте ваш API ключ в `YANDEX_MAPS_API_KEY`

### 2. Создание суперпользователя

Для доступа к админ-панели создайте суперпользователя:

```bash
python manage.py createsuperuser
```

### 3. Доступ к приложению

- **Главная страница с картой:** https://ваш-replit-домен.repl.co/
- **Загрузка GeoJSON:** https://ваш-replit-домен.repl.co/upload-geojson/ (только для администраторов)
- **Админ-панель:** https://ваш-replit-домен.repl.co/admin/
- **Импорт GeoJSON в админке:** https://ваш-replit-домен.repl.co/admin/licenses/license/import-geojson/
- **API лицензий:** https://ваш-replit-домен.repl.co/api/licenses/

## Заглушки для будущей интеграции

### LDAP авторизация

В файле `mineral_licenses/settings.py` находятся закомментированные настройки для LDAP:

```python
# AUTHENTICATION_BACKENDS = [
#     'django_auth_ldap.backend.LDAPBackend',
#     'django.contrib.auth.backends.ModelBackend',
# ]
```

**Для активации:**
1. Установите `django-auth-ldap`: `pip install django-auth-ldap`
2. Раскомментируйте секцию LDAP в settings.py
3. Настройте параметры подключения к вашему LDAP серверу
4. Добавьте настройки в `.env` файл

### Внешняя база данных

В settings.py есть закомментированная конфигурация для PostgreSQL:

```python
# DATABASES = {
#     'default': {
#         'ENGINE': 'django.db.backends.postgresql',
#         ...
#     }
# }
```

**Для активации:**
1. Установите `psycopg2-binary`: `pip install psycopg2-binary`
2. Раскомментируйте секцию DATABASES в settings.py
3. Настройте параметры подключения
4. Добавьте настройки в `.env` файл
5. Выполните миграции: `python manage.py migrate`

## API Endpoints

### GET /api/licenses/
Получение списка всех лицензий в формате JSON

### GET /api/licenses/<id>/
Получение детальной информации о лицензии

### POST /api/licenses/<id>/upload/
Загрузка документа для лицензии (требуется авторизация)

### GET /api/documents/<id>/download/
Скачивание документа

## Тестовые данные

Проект содержит тестовые данные о лицензиях для демонстрации:
- 6 лицензий из разных регионов России
- Разные типы лицензий и полезных ископаемых
- Различные статусы (действующие, приостановленные, истекшие)

## Технологии

- **Backend:** Django 5.2.7
- **Frontend:** Bootstrap 5, Vanilla JavaScript
- **Карты:** Яндекс.Карты JavaScript API 2.1
- **БД:** SQLite (разработка), PostgreSQL (готово к продакшн)
- **Авторизация:** Django Auth (текущая), LDAP (готово к интеграции)

## Дополнительные команды

### Создание тестовых данных
```bash
python create_test_data.py
```

### Импорт GeoJSON файлов через командную строку
```bash
python manage.py import_geojson путь/к/файлу.geojson
```

### Создание миграций
```bash
python manage.py makemigrations
python manage.py migrate
```

### Запуск сервера
```bash
python manage.py runserver 0.0.0.0:5000
```

## Дата создания
16 октября 2025

## Последние изменения
- 16.10.2025: Создание базовой структуры проекта
- 16.10.2025: Реализация интеграции с Яндекс.Картами
- 16.10.2025: Добавление функционала загрузки/скачивания документов
- 16.10.2025: Настройка заглушек для LDAP и БД
- 28.10.2025: Реализация функциональности загрузки GeoJSON карт через веб-интерфейс и админку
- **28.10.2025: Настройка PostgreSQL базы данных (Neon)**
- **28.10.2025: Выполнены все миграции БД**
- **28.10.2025: Создан файл INSTRUCTIONS.md с полным руководством на русском языке**

## Загрузка GeoJSON карт

### Методы загрузки

Реализовано **три способа** загрузки GeoJSON файлов с картами лицензий:

#### 1. Веб-интерфейс (для администраторов)
- Доступ: `/upload-geojson/` или через кнопку "Загрузить GeoJSON" в навигации
- Требования: авторизация с правами администратора (is_staff)
- Функции: 
  - Загрузка через форму или drag-and-drop
  - Детальная статистика импорта
  - Список ошибок и предупреждений

#### 2. Админ-панель Django
- Доступ: `/admin/licenses/license/import-geojson/`
- Требования: доступ к админ-панели
- Функции:
  - Простая форма загрузки
  - Сообщения о результатах импорта
  - Интеграция с Django messages

#### 3. Командная строка
```bash
python manage.py import_geojson путь/к/файлу.geojson
```

### Особенности импорта

- **Автоматическое обновление**: Если лицензия с таким номером уже существует, данные обновляются
- **Единая карта**: Все полигоны из разных файлов добавляются на одну карту
- **Парсинг данных**: Автоматическое извлечение информации из описания лицензий
- **Определение региона**: Автоматическое определение региона по префиксу номера лицензии
- **Вычисление центра**: Автоматический расчёт центральной точки полигона
- **Статус по цвету**: Определение статуса лицензии по цвету в GeoJSON

### Безопасность

- Доступ к загрузке только для пользователей с правами администратора (is_staff)
- Валидация формата файлов (.geojson, .json)
- Обработка ошибок при парсинге
- Транзакционная безопасность при импорте
